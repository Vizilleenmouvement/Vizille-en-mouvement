<!DOCTYPE html>
<html lang="fr">
<head>
    <script>
        // Protection par mot de passe - @@@@
        (function() {
            const PASSWORD = '@@@@';
            const MAX_ATTEMPTS = 3;
            
            if (!sessionStorage.getItem('vizille_auth')) {
                let attempts = 0;
                let authenticated = false;
                
                while (!authenticated && attempts < MAX_ATTEMPTS) {
                    const input = prompt('Mot de passe requis pour acc√©der au site :');
                    
                    if (input === null) {
                        window.location.href = 'about:blank';
                        break;
                    }
                    
                    if (input === PASSWORD) {
                        authenticated = true;
                        sessionStorage.setItem('vizille_auth', 'true');
                    } else {
                        attempts++;
                        if (attempts < MAX_ATTEMPTS) {
                            alert('Mot de passe incorrect. Tentative ' + attempts + '/' + MAX_ATTEMPTS);
                        } else {
                            alert('Trop de tentatives. Acc√®s refus√©.');
                            window.location.href = 'about:blank';
                        }
                    }
                }
                
                if (!authenticated) {
                    document.body.innerHTML = '';
                }
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Vizille en Mouvement</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bleu: #1a3a5c;
            --bleu-clair: #2d5a87;
            --or: #c9a227;
            --vert: #27ae60;
            --orange: #f39c12;
            --rouge: #e74c3c;
            --gris-bg: #f5f7fa;
            --gris-border: #e1e5eb;
            --gris-texte: #4a5568;
            --blanc: #ffffff;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --radius: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gris-bg);
            color: var(--gris-texte);
            line-height: 1.6;
        }
        
        /* ===== LOGIN ===== */
        .login-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--bleu) 0%, var(--bleu-clair) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-overlay.hidden { display: none; }
        
        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .login-box h2 {
            color: var(--bleu);
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }
        
        .login-box > p {
            color: var(--or);
            margin-bottom: 2rem;
            font-weight: 500;
        }
        
        .login-box input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--gris-border);
            border-radius: 10px;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .login-box input:focus {
            outline: none;
            border-color: var(--bleu);
        }
        
        .login-box button {
            width: 100%;
            padding: 1rem;
            background: var(--bleu);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .login-box button:hover {
            background: var(--bleu-clair);
            transform: translateY(-2px);
        }
        
        .login-error {
            color: var(--rouge);
            margin-top: 1rem;
            font-weight: 500;
        }
        
        /* ===== THEME BUTTONS ===== */
        .theme-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gris-border);
            background: white;
            border-radius: 25px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .theme-btn:hover {
            border-color: var(--bleu);
            background: var(--gris-bg);
        }
        
        .theme-btn.active {
            background: var(--bleu);
            color: white;
            border-color: var(--bleu);
        }
        
        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--bleu) 0%, var(--bleu-clair) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header h1 { font-size: 1.3rem; font-weight: 600; }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .token-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            width: 200px;
        }
        
        .token-input::placeholder { color: rgba(255,255,255,0.5); }
        
        /* ===== NAVIGATION ===== */
        .nav-tabs {
            background: var(--blanc);
            border-bottom: 1px solid var(--gris-border);
            display: flex;
            padding: 0 1rem;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 1rem 1.25rem;
            border: none;
            background: none;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gris-texte);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .nav-tab:hover { color: var(--bleu); background: var(--gris-bg); }
        .nav-tab.active { color: var(--bleu); border-bottom-color: var(--or); }
        
        /* ===== MAIN ===== */
        main { padding: 1.5rem; max-width: 1400px; margin: 0 auto; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ===== CARD ===== */
        .card {
            background: var(--blanc);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--bleu) 0%, var(--bleu-clair) 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 { font-size: 1.1rem; font-weight: 600; }
        
        .publish-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .status {
            font-size: 0.85rem;
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
        }
        
        .status.modified { background: var(--orange); }
        .status.saved { background: var(--vert); }
        .status.loading { background: rgba(255,255,255,0.3); }
        
        .btn-publish {
            background: var(--vert);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-publish:hover { background: #219a52; transform: translateY(-1px); }
        .btn-publish:disabled { background: #95a5a6; cursor: not-allowed; transform: none; }
        
        .card-body { padding: 1.5rem; }
        
        /* ===== FORMS ===== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group { margin-bottom: 1rem; }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--bleu);
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gris-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--bleu);
        }
        
        /* ===== PHOTO UPLOAD ===== */
        .photo-upload {
            border: 2px dashed var(--gris-border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gris-bg);
        }
        
        .photo-upload:hover {
            border-color: var(--bleu);
            background: #eef2f7;
        }
        
        .photo-upload.dragover {
            border-color: var(--vert);
            background: #e8f5e9;
        }
        
        .photo-upload input { display: none; }
        
        .photo-upload .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        
        .photo-upload p { color: var(--gris-texte); font-size: 0.9rem; }
        
        .photo-preview {
            margin-top: 1rem;
            display: none;
        }
        
        .photo-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            object-fit: cover;
            border: 3px solid var(--vert);
        }
        
        .photo-preview.active { display: block; }
        
        /* ===== BUTTONS ===== */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary { background: var(--bleu); color: white; }
        .btn-primary:hover { background: var(--bleu-clair); }
        .btn-success { background: var(--vert); color: white; }
        .btn-danger { background: var(--rouge); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--gris-border); color: var(--gris-texte); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        
        /* ===== ITEMS LIST ===== */
        .items-list { margin-top: 1.5rem; }
        
        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--gris-border);
        }
        
        .items-header h3 { color: var(--bleu); font-size: 1.1rem; }
        
        .item-card {
            background: var(--gris-bg);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .item-card:hover { background: #eef1f5; }
        
        .item-info { flex: 1; display: flex; gap: 1rem; align-items: flex-start; }
        
        .item-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--gris-border);
            flex-shrink: 0;
        }
        
        .item-photo-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gris-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .item-text { flex: 1; }
        
        .item-badge {
            display: inline-block;
            font-size: 0.75rem;
            background: #dbeafe;
            color: var(--bleu);
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
        }
        
        .item-title {
            font-weight: 600;
            color: var(--bleu);
            margin-bottom: 0.25rem;
        }
        
        .item-desc {
            font-size: 0.9rem;
            color: var(--gris-texte);
        }
        
        .item-actions { display: flex; gap: 0.5rem; }

        /* ===== CARDS GRID (style bilan/projet) ===== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.25rem;
            margin-top: 1rem;
        }

        .admin-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .admin-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: var(--or);
        }

        .admin-card-header {
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-card-theme {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            color: white;
        }

        .admin-card-statut {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .statut-realise { background: rgba(39, 174, 96, 0.15); color: #27ae60; }
        .statut-encours { background: rgba(243, 156, 18, 0.15); color: #f39c12; }
        .statut-prevu { background: rgba(52, 152, 219, 0.15); color: #3498db; }
        .statut-prioritaire { background: rgba(231, 76, 60, 0.15); color: #e74c3c; }
        .statut-court-terme { background: rgba(243, 156, 18, 0.15); color: #f39c12; }
        .statut-moyen-terme { background: rgba(52, 152, 219, 0.15); color: #3498db; }

        .admin-card-body {
            padding: 0 1.25rem 1.25rem;
        }

        .admin-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--bleu);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .admin-card-desc {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .admin-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gris-border);
        }

        .admin-card-meta {
            font-size: 0.85rem;
            color: #888;
            font-weight: 500;
        }

        .admin-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== THEMES GRID (groupement par th√®me) ===== */
        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
            margin-top: 1rem;
        }

        .theme-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .theme-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .theme-card-header {
            padding: 1.25rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .theme-card-icon {
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .theme-card-info h3 {
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
        }

        .theme-card-info .count {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .theme-card-stats {
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gris-bg);
        }

        .theme-card-stats span {
            font-size: 0.85rem;
            color: var(--gris-texte);
        }

        .theme-card-arrow {
            font-size: 1.2rem;
            color: var(--or);
            transition: transform 0.3s;
        }

        .theme-card:hover .theme-card-arrow {
            transform: translateX(5px);
        }

        /* D√©tail d'un th√®me */
        .theme-detail {
            margin-top: 1rem;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .theme-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gris-border);
        }

        .theme-detail-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--bleu);
        }

        .btn-back-theme {
            padding: 0.5rem 1rem;
            background: var(--gris-bg);
            border: 2px solid var(--gris-border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-back-theme:hover {
            background: var(--bleu);
            color: white;
            border-color: var(--bleu);
        }

        /* ===== CANDIDAT CARDS ===== */
        .candidat-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .candidat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: var(--or);
        }

        .candidat-card-photo {
            position: relative;
            height: 180px;
            background: linear-gradient(135deg, var(--bleu) 0%, var(--bleu-clair) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .candidat-card-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .candidat-card-photo .no-photo {
            font-size: 4rem;
            color: rgba(255,255,255,0.5);
        }

        .candidat-card-ordre {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--or);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .candidat-card-body {
            padding: 1.25rem;
        }

        .candidat-card-name {
            font-weight: 700;
            font-size: 1.15rem;
            color: var(--bleu);
            margin-bottom: 0.25rem;
        }

        .candidat-card-role {
            font-size: 0.85rem;
            color: var(--or);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .candidat-card-delegation {
            font-size: 0.8rem;
            color: #666;
            background: #f0f4f8;
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 15px;
            margin-bottom: 0.75rem;
        }

        .candidat-card-bio {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .candidat-card-citation {
            font-size: 0.85rem;
            font-style: italic;
            color: var(--bleu);
            background: linear-gradient(135deg, rgba(26,58,92,0.05) 0%, rgba(201,162,39,0.1) 100%);
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            border-left: 3px solid var(--or);
            margin-bottom: 1rem;
        }

        .candidat-card-socials {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .candidat-card-socials a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f0f4f8;
            font-size: 1rem;
            text-decoration: none;
            transition: all 0.2s;
        }

        .candidat-card-socials a:hover {
            background: var(--bleu);
            transform: scale(1.1);
        }

        .candidat-card-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gris-border);
        }

        /* ===== ARTICLE CARDS ===== */
        .article-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: var(--or);
        }

        .article-card-image {
            position: relative;
            height: 140px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .article-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .article-card-image .no-image {
            font-size: 3rem;
            color: rgba(255,255,255,0.5);
        }

        .article-card-category {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .article-card-category.evenement { background: #3498db; }
        .article-card-category.communique { background: #e74c3c; }
        .article-card-category.reunion { background: #27ae60; }
        .article-card-category.action { background: #9b59b6; }
        .article-card-category.bilan { background: #f39c12; }
        .article-card-category.projet { background: #1abc9c; }
        .article-card-category.tribune { background: #34495e; }
        .article-card-category.info { background: #95a5a6; }

        .article-card-body {
            padding: 1.25rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .article-card-date {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .article-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--bleu);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .article-card-extrait {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
        }

        .article-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            margin-top: 1rem;
            border-top: 1px solid var(--gris-border);
        }

        .article-card-share {
            display: flex;
            gap: 0.5rem;
        }

        /* ===== DASHBOARD STATS ===== */
        .dashboard-stat-card:hover {
            transform: translateY(-3px) scale(1.02);
        }

        /* ===== GLOBAL SEARCH ===== */
        .global-search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .global-search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--gris-border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--bleu);
            box-shadow: 0 0 0 3px rgba(26, 58, 92, 0.1);
        }

        .global-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--gris-texte);
        }

        .global-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gris-border);
            border-radius: 12px;
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }

        .global-search-results.active {
            display: block;
        }

        .search-result-group {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gris-border);
        }

        .search-result-group:last-child {
            border-bottom: none;
        }

        .search-result-group-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--or);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .search-result-item {
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .search-result-item:hover {
            background: var(--gris-bg);
        }

        .search-result-item .icon {
            font-size: 1.2rem;
        }

        .search-result-item .title {
            font-weight: 500;
            color: var(--bleu);
        }

        .search-result-item .subtitle {
            font-size: 0.8rem;
            color: var(--gris-texte);
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--vert); }
        .toast.error { background: var(--rouge); }
        .toast.warning { background: var(--orange); }
        .toast.info { background: var(--bleu); }
        
        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 1rem;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gris-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 { color: var(--bleu); }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gris-texte);
        }
        
        .modal-body { padding: 1.5rem; }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gris-border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gris-texte);
        }
        
        .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 1rem; text-align: center; }
            .header-actions { width: 100%; justify-content: center; flex-wrap: wrap; }
            .card-header { flex-direction: column; gap: 1rem; }
            .publish-bar { width: 100%; justify-content: space-between; }
            .form-row { grid-template-columns: 1fr; }
            .item-info { flex-direction: column; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="header">
        <h1>‚öôÔ∏è Administration - Vizille en Mouvement</h1>
        <div class="header-actions">
            <input type="password" class="token-input" id="github-token" placeholder="üîê Token GitHub" onchange="saveToken()">
            <button class="btn btn-sm" style="background: rgba(255,255,255,0.2);" onclick="toggleToken()">üëÅÔ∏è</button>
            <a href="https://Vizilleenmouvement.github.io/Vizille-en-mouvement/" target="_blank" class="btn btn-sm" style="background: var(--or); color: var(--bleu);">üåê Voir le site</a>
        </div>
    </header>

    <!-- RECHERCHE GLOBALE -->
    <div style="background: white; padding: 0.75rem 1rem; border-bottom: 1px solid var(--gris-border);">
        <div class="global-search-container" style="max-width: 600px; margin: 0 auto;">
            <span class="global-search-icon">üîç</span>
            <input type="text" class="global-search-input" id="global-search" placeholder="Rechercher dans tout le contenu..." oninput="handleGlobalSearch(this.value)" onfocus="handleGlobalSearch(this.value)">
            <div class="global-search-results" id="global-search-results"></div>
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav class="nav-tabs">
        <button class="nav-tab active" data-tab="accueil">üè† Accueil</button>
        <button class="nav-tab" data-tab="projets">üöÄ Projets</button>
        <button class="nav-tab" data-tab="themes">üé® Th√®mes</button>
        <button class="nav-tab" data-tab="actions">üìä Actions</button>
        <button class="nav-tab" data-tab="candidats">üë• Candidats</button>
        <button class="nav-tab" data-tab="faq">ü§ù Construisons ensemble</button>
        <button class="nav-tab" data-tab="articles">üì∞ Articles</button>
        <button class="nav-tab" data-tab="communication">üì¢ Communication</button>
        <button class="nav-tab" data-tab="config">‚öôÔ∏è Param√®tres</button>
    </nav>

    <!-- MAIN -->
    <main>
        
        <!-- TAB: ACCUEIL -->
        <section class="tab-content active" id="tab-accueil">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #1a3a5c 0%, #c9a227 100%);">
                    <h2>üè† Bienvenue dans l'Administration</h2>
                </div>
                <div class="card-body">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h1 style="color: var(--bleu); font-size: 2rem; margin-bottom: 0.5rem;">Vizille en Mouvement</h1>
                        <p style="color: var(--or); font-size: 1.2rem;">Interface de gestion du site de campagne</p>
                    </div>

                    <!-- DASHBOARD STATISTIQUES -->
                    <div id="dashboard-stats" style="margin-bottom: 2rem;">
                        <h3 style="color: var(--bleu); margin-bottom: 1rem;">üìä Tableau de bord</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
                            <div class="dashboard-stat-card" onclick="switchTab('projets')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üöÄ</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="stat-projets">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Projets</div>
                            </div>
                            <div class="dashboard-stat-card" onclick="switchTab('actions')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="stat-actions">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Actions bilan</div>
                            </div>
                            <div class="dashboard-stat-card" onclick="switchTab('candidats')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üë•</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="stat-candidats">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Candidats</div>
                            </div>
                            <div class="dashboard-stat-card" onclick="switchTab('articles')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∞</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="stat-articles">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Articles</div>
                            </div>
                            <div class="dashboard-stat-card" onclick="switchTab('themes')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üé®</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="stat-themes">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Th√®mes</div>
                            </div>
                            <div class="dashboard-stat-card" onclick="switchTab('communication')" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìß</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="stat-abonnes">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Abonn√©s</div>
                            </div>
                        </div>

                        <!-- Derni√®res activit√©s -->
                        <div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                            <div style="background: white; border: 1px solid var(--gris-border); border-radius: 12px; padding: 1.25rem;">
                                <h4 style="color: var(--bleu); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üì∞</span> Derniers articles
                                </h4>
                                <div id="dashboard-recent-articles" style="font-size: 0.9rem; color: var(--gris-texte);">
                                    Chargement...
                                </div>
                            </div>
                            <div style="background: white; border: 1px solid var(--gris-border); border-radius: 12px; padding: 1.25rem;">
                                <h4 style="color: var(--bleu); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üìä</span> R√©partition actions
                                </h4>
                                <div id="dashboard-actions-stats" style="font-size: 0.9rem; color: var(--gris-texte);">
                                    Chargement...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- √âTAPES -->
                    <div style="background: #e8f4fc; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <h3 style="color: var(--bleu); margin-bottom: 1rem;">üöÄ Comment √ßa marche ?</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">1Ô∏è‚É£</div>
                                <strong style="color: var(--bleu);">Configurer le token</strong>
                                <p style="font-size: 0.9rem; color: var(--gris-texte);">Collez le token GitHub en haut de page (une seule fois)</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">2Ô∏è‚É£</div>
                                <strong style="color: var(--bleu);">Modifier le contenu</strong>
                                <p style="font-size: 0.9rem; color: var(--gris-texte);">Ajoutez, modifiez ou supprimez des √©l√©ments</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">3Ô∏è‚É£</div>
                                <strong style="color: var(--bleu);">Publier</strong>
                                <p style="font-size: 0.9rem; color: var(--gris-texte);">Cliquez sur üöÄ Publier dans l'onglet modifi√©</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">4Ô∏è‚É£</div>
                                <strong style="color: var(--bleu);">C'est en ligne !</strong>
                                <p style="font-size: 0.9rem; color: var(--gris-texte);">Le site se met √† jour en 1-2 minutes</p>
                            </div>
                        </div>
                    </div>

                    <!-- ONGLETS -->
                    <h3 style="color: var(--bleu); margin-bottom: 1rem;">üìë Les onglets</h3>
                    <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--gris-bg); border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üöÄ</span>
                            <div>
                                <strong style="color: var(--bleu);">Projets</strong>
                                <p style="font-size: 0.9rem; margin: 0;">Les projets du programme 2026-2032 ‚Üí Page "Notre Projet"</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--gris-bg); border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üìä</span>
                            <div>
                                <strong style="color: var(--bleu);">Actions</strong>
                                <p style="font-size: 0.9rem; margin: 0;">Les 330 actions du bilan 2020-2026 ‚Üí Page "Bilan"</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--gris-bg); border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üë•</span>
                            <div>
                                <strong style="color: var(--bleu);">Candidats</strong>
                                <p style="font-size: 0.9rem; margin: 0;">L'√©quipe et les colistiers avec photos ‚Üí Page "√âquipe"</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--gris-bg); border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üí¨</span>
                            <div>
                                <strong style="color: var(--bleu);">Construisons ensemble</strong>
                                <p style="font-size: 0.9rem; margin: 0;">Questions, id√©es, contact ‚Üí Page "Construisons ensemble"</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--gris-bg); border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üì∞</span>
                            <div>
                                <strong style="color: var(--bleu);">Articles</strong>
                                <p style="font-size: 0.9rem; margin: 0;">Actualit√©s et communiqu√©s ‚Üí Page "Blog"</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--gris-bg); border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üì¢</span>
                            <div>
                                <strong style="color: var(--bleu);">Communication</strong>
                                <p style="font-size: 0.9rem; margin: 0;">Abonn√©s newsletter, partage Facebook, envoi newsletter</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--gris-bg); border-radius: 8px;">
                            <span style="font-size: 1.5rem;">‚öôÔ∏è</span>
                            <div>
                                <strong style="color: var(--bleu);">Param√®tres</strong>
                                <p style="font-size: 0.9rem; margin: 0;">Coordonn√©es, r√©seaux sociaux, permanences ‚Üí Page "Construisons ensemble"</p>
                            </div>
                        </div>
                    </div>

                    <!-- STATUTS -->
                    <h3 style="color: var(--bleu); margin-bottom: 1rem;">üö¶ Les statuts</h3>
                    <div style="display: flex; gap: 2rem; flex-wrap: wrap; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--vert); color: white; padding: 0.3rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">‚úì √Ä jour</span>
                            <span>= Aucune modification en attente</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--orange); color: white; padding: 0.3rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">‚ö†Ô∏è Modifi√©</span>
                            <span>= Modifications √† publier</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: rgba(0,0,0,0.3); color: white; padding: 0.3rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">‚è≥ Publication...</span>
                            <span>= Envoi en cours</span>
                        </div>
                    </div>

                    <!-- TOKEN -->
                    <div style="background: #1b1f23; color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">üîê Le Token GitHub</h3>
                        <p style="margin-bottom: 1rem;">Le token permet de publier directement sur le site. Il est sauvegard√© dans votre navigateur.</p>
                        <ul style="margin-left: 1.5rem; line-height: 2;">
                            <li>Collez-le dans le champ üîê en haut de page</li>
                            <li>Cliquez sur üëÅÔ∏è pour le voir/masquer</li>
                            <li>Il est m√©moris√© automatiquement</li>
                        </ul>
                        <p style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 0.9rem;">
                            ‚ö†Ô∏è Ne partagez pas ce token publiquement. Demandez-le √† Michel si besoin.
                        </p>
                    </div>

                    <!-- LIENS -->
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <a href="https://Vizilleenmouvement.github.io/Vizille-en-mouvement/" target="_blank" style="display: inline-flex; align-items: center; gap: 0.5rem; background: var(--bleu); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600;">
                            üåê Voir le site en ligne
                        </a>
                        <a href="https://github.com/Vizilleenmouvement/Vizille-en-mouvement" target="_blank" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #333; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600;">
                            üìÅ Voir sur GitHub
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: PROJETS -->
        <section class="tab-content" id="tab-projets">
            <div class="card">
                <div class="card-header">
                    <h2>üöÄ Projets 2026-2032</h2>
                    <div class="publish-bar">
                        <span class="status saved" id="status-projets">‚úì √Ä jour</span>
                        <button class="btn-publish" onclick="publish('projets')">üöÄ Publier</button>
                    </div>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" onclick="openAddProjet()">+ Ajouter un projet</button>
                    
                    <!-- FILTRES PAR TH√àME -->
                    <div style="margin: 1.5rem 0;">
                        <h4 style="color: var(--bleu); margin-bottom: 0.75rem;">Filtrer par th√®me :</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="projet-theme-filters">
                            <button class="theme-btn active" data-theme="" onclick="filterProjets('')">
                                üìã Tous (<span id="pcount-all">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="urbanisme" onclick="filterProjets('urbanisme')">
                                üèòÔ∏è Urbanisme (<span id="pcount-urbanisme">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="environnement" onclick="filterProjets('environnement')">
                                üåø Environnement (<span id="pcount-environnement">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="solidarite" onclick="filterProjets('solidarite')">
                                ü§ù Solidarit√© (<span id="pcount-solidarite">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="sante" onclick="filterProjets('sante')">
                                üè• Sant√© (<span id="pcount-sante">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="enfance" onclick="filterProjets('enfance')">
                                üë∂ Enfance (<span id="pcount-enfance">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="culture" onclick="filterProjets('culture')">
                                üé≠ Culture (<span id="pcount-culture">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="sport" onclick="filterProjets('sport')">
                                ‚öΩ Sport (<span id="pcount-sport">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="economie" onclick="filterProjets('economie')">
                                üíº √âconomie (<span id="pcount-economie">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="tranquillite" onclick="filterProjets('tranquillite')">
                                üõ°Ô∏è Tranquillit√© (<span id="pcount-tranquillite">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="mobilites" onclick="filterProjets('mobilites')">
                                üö¥ Mobilit√©s (<span id="pcount-mobilites">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="seniors" onclick="filterProjets('seniors')">
                                üë¥ Seniors (<span id="pcount-seniors">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="democratie" onclick="filterProjets('democratie')">
                                üó£Ô∏è D√©mocratie (<span id="pcount-democratie">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="metropole" onclick="filterProjets('metropole')">
                                üèõÔ∏è M√©tropole (<span id="pcount-metropole">0</span>)
                            </button>
                        </div>
                    </div>
                    
                    <div class="items-list">
                        <div class="items-header">
                            <h3>Projets : <span id="projets-count">0</span></h3>
                            <input type="text" id="search-projets" placeholder="üîç Rechercher..." style="padding: 0.5rem 1rem; border: 2px solid var(--gris-border); border-radius: 8px; width: 200px;" oninput="renderProjets()">
                        </div>
                        <div id="projets-themes-view" class="themes-grid"></div>
                        <div id="projets-detail-view" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: TH√àMES -->
        <section class="tab-content" id="tab-themes">
            <div class="card">
                <div class="card-header">
                    <h2>üé® Gestion des Th√®mes</h2>
                    <div class="publish-bar">
                        <span class="status saved" id="status-themes">‚úì √Ä jour</span>
                        <button class="btn-publish" onclick="publish('themes')">üöÄ Publier</button>
                    </div>
                </div>
                <div class="card-body">
                    <p style="color: #666; margin-bottom: 1.5rem;">
                        G√©rez les th√®mes disponibles pour classer vos projets. Un th√®me ne peut √™tre supprim√© que s'il n'est rattach√© √† aucun projet.
                    </p>
                    
                    <!-- Formulaire d'ajout -->
                    <div style="display: flex; gap: 10px; margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
                            <label style="font-size: 0.85rem;">Nom du th√®me</label>
                            <input type="text" id="new-theme-name" placeholder="Ex: Num√©rique" maxlength="30" style="width: 100%;">
                        </div>
                        <div class="form-group" style="margin: 0; width: 80px;">
                            <label style="font-size: 0.85rem;">Ic√¥ne</label>
                            <select id="new-theme-icon" style="width: 100%; font-size: 1.2rem; text-align: center;">
                                <option value="üìå">üìå</option>
                                <option value="üè•">üè•</option>
                                <option value="üèòÔ∏è">üèòÔ∏è</option>
                                <option value="üåø">üåø</option>
                                <option value="üé≠">üé≠</option>
                                <option value="üèõÔ∏è">üèõÔ∏è</option>
                                <option value="üë∂">üë∂</option>
                                <option value="ü§ù">ü§ù</option>
                                <option value="‚öΩ">‚öΩ</option>
                                <option value="üíº">üíº</option>
                                <option value="üö¥">üö¥</option>
                                <option value="üõ°Ô∏è">üõ°Ô∏è</option>
                                <option value="üèóÔ∏è">üèóÔ∏è</option>
                                <option value="üí∞">üí∞</option>
                                <option value="üë•">üë•</option>
                                <option value="üìö">üìö</option>
                                <option value="üéì">üéì</option>
                                <option value="üó≥Ô∏è">üó≥Ô∏è</option>
                                <option value="üéØ">üéØ</option>
                                <option value="üåç">üåç</option>
                                <option value="üöó">üöó</option>
                                <option value="üè†">üè†</option>
                                <option value="üí°">üí°</option>
                                <option value="üì±">üì±</option>
                                <option value="üå≥">üå≥</option>
                                <option value="üë¥">üë¥</option>
                                <option value="üó£Ô∏è">üó£Ô∏è</option>
                                <option value="üé™">üé™</option>
                                <option value="üèÜ">üèÜ</option>
                                <option value="üîß">üîß</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0; width: 80px;">
                            <label style="font-size: 0.85rem;">Couleur</label>
                            <input type="color" id="new-theme-color" value="#1a3a5c" style="width: 100%; height: 38px; border: none; border-radius: 4px; cursor: pointer;">
                        </div>
                        <button class="btn btn-primary" onclick="addNewTheme()" style="height: 38px;">
                            + Ajouter
                        </button>
                    </div>
                    
                    <!-- Liste des th√®mes -->
                    <h4 style="color: var(--bleu); margin-bottom: 1rem;">Th√®mes existants (<span id="themes-count">0</span>)</h4>
                    <div id="themes-list" class="themes-grid">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: ACTIONS -->
        <section class="tab-content" id="tab-actions">
            <div class="card">
                <div class="card-header">
                    <h2>üìä Actions du Bilan 2020-2026</h2>
                    <div class="publish-bar">
                        <span class="status saved" id="status-actions">‚úì √Ä jour</span>
                        <button class="btn-publish" onclick="publish('actions')">üöÄ Publier</button>
                    </div>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" onclick="openAddAction()">+ Ajouter une action</button>
                    
                    <!-- FILTRES PAR TH√àME -->
                    <div style="margin: 1.5rem 0;">
                        <h4 style="color: var(--bleu); margin-bottom: 0.75rem;">Filtrer par th√®me :</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="theme-filters">
                            <button class="theme-btn active" data-theme="" onclick="filterActions('')">
                                üìã Tous (<span id="count-all">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Urbanisme" onclick="filterActions('Urbanisme')">
                                üèóÔ∏è Urbanisme (<span id="count-Urbanisme">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Sant√©" onclick="filterActions('Sant√©')">
                                üè• Sant√© (<span id="count-Sant√©">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Environnement" onclick="filterActions('Environnement')">
                                üå± Environnement (<span id="count-Environnement">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Culture" onclick="filterActions('Culture')">
                                üé≠ Culture (<span id="count-Culture">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Patrimoine" onclick="filterActions('Patrimoine')">
                                üèõÔ∏è Patrimoine (<span id="count-Patrimoine">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Enfance" onclick="filterActions('Enfance')">
                                üë∂ Enfance (<span id="count-Enfance">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Solidarit√©" onclick="filterActions('Solidarit√©')">
                                ü§ù Solidarit√© (<span id="count-Solidarit√©">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Sport" onclick="filterActions('Sport')">
                                ‚öΩ Sport (<span id="count-Sport">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="√âconomie" onclick="filterActions('√âconomie')">
                                üíº √âconomie (<span id="count-√âconomie">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Tranquillit√©" onclick="filterActions('Tranquillit√©')">
                                üõ°Ô∏è Tranquillit√© (<span id="count-Tranquillit√©">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Mobilit√©s" onclick="filterActions('Mobilit√©s')">
                                üö≤ Mobilit√©s (<span id="count-Mobilit√©s">0</span>)
                            </button>
                            <button class="theme-btn" data-theme="Finance" onclick="filterActions('Finance')">
                                üí∞ Finance (<span id="count-Finance">0</span>)
                            </button>
                        </div>
                    </div>
                    
                    <div class="items-list">
                        <div class="items-header">
                            <h3>Actions : <span id="actions-count">0</span></h3>
                            <input type="text" id="search-actions" placeholder="üîç Rechercher..." style="padding: 0.5rem 1rem; border: 2px solid var(--gris-border); border-radius: 8px; width: 200px;" oninput="renderActions()">
                        </div>
                        <div id="actions-themes-view" class="themes-grid"></div>
                        <div id="actions-detail-view" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: CANDIDATS -->
        <section class="tab-content" id="tab-candidats">
            <div class="card">
                <div class="card-header">
                    <h2>üë• Candidats</h2>
                    <div class="publish-bar">
                        <span class="status saved" id="status-candidats">‚úì √Ä jour</span>
                        <button class="btn-publish" onclick="publish('candidats')">üöÄ Publier</button>
                    </div>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" onclick="openAddCandidat()">+ Ajouter un candidat</button>

                    <div class="items-list">
                        <div class="items-header">
                            <h3>Candidats (<span id="candidats-count">0</span>)</h3>
                            <input type="text" id="search-candidats" placeholder="üîç Rechercher..." style="padding: 0.5rem 1rem; border: 2px solid var(--gris-border); border-radius: 8px; width: 200px;" oninput="renderCandidats()">
                        </div>
                        <div id="candidats-list" class="cards-grid"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: FAQ -->
        <section class="tab-content" id="tab-faq">
            <div class="card">
                <div class="card-header">
                    <h2>ü§ù Construisons ensemble - Questions / R√©ponses</h2>
                    <div class="publish-bar">
                        <span class="status saved" id="status-faq">‚úì √Ä jour</span>
                        <button class="btn-publish" onclick="publish('faq')">üöÄ Publier</button>
                    </div>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" onclick="openAddFaq()">+ Ajouter une question</button>
                    
                    <div class="items-list">
                        <div class="items-header">
                            <h3>Questions (<span id="faq-count">0</span>)</h3>
                        </div>
                        <div id="faq-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: ARTICLES -->
        <section class="tab-content" id="tab-articles">
            <div class="card">
                <div class="card-header">
                    <h2>üì∞ Articles / Actualit√©s</h2>
                    <div class="publish-bar">
                        <span class="status saved" id="status-articles">‚úì √Ä jour</span>
                        <button class="btn-publish" onclick="publish('articles')">üöÄ Publier</button>
                    </div>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" onclick="openAddArticle()">+ Ajouter un article</button>

                    <!-- FILTRES PAR CAT√âGORIE -->
                    <div style="margin: 1.5rem 0;">
                        <h4 style="color: var(--bleu); margin-bottom: 0.75rem;">Filtrer par cat√©gorie :</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="article-category-filters">
                            <button class="theme-btn active" data-category="" onclick="filterArticles('')">
                                üìã Tous (<span id="acount-all">0</span>)
                            </button>
                            <button class="theme-btn" data-category="√âv√©nement" onclick="filterArticles('√âv√©nement')">
                                üìÖ √âv√©nement (<span id="acount-evenement">0</span>)
                            </button>
                            <button class="theme-btn" data-category="Communiqu√©" onclick="filterArticles('Communiqu√©')">
                                üì£ Communiqu√© (<span id="acount-communique">0</span>)
                            </button>
                            <button class="theme-btn" data-category="R√©union" onclick="filterArticles('R√©union')">
                                ü§ù R√©union (<span id="acount-reunion">0</span>)
                            </button>
                            <button class="theme-btn" data-category="Action" onclick="filterArticles('Action')">
                                ‚úä Action (<span id="acount-action">0</span>)
                            </button>
                            <button class="theme-btn" data-category="Bilan" onclick="filterArticles('Bilan')">
                                üìä Bilan (<span id="acount-bilan">0</span>)
                            </button>
                            <button class="theme-btn" data-category="Projet" onclick="filterArticles('Projet')">
                                üöÄ Projet (<span id="acount-projet">0</span>)
                            </button>
                            <button class="theme-btn" data-category="Tribune" onclick="filterArticles('Tribune')">
                                üìù Tribune (<span id="acount-tribune">0</span>)
                            </button>
                            <button class="theme-btn" data-category="Info" onclick="filterArticles('Info')">
                                ‚ÑπÔ∏è Info (<span id="acount-info">0</span>)
                            </button>
                        </div>
                    </div>

                    <div class="items-list">
                        <div class="items-header">
                            <h3>Articles (<span id="articles-count">0</span>)</h3>
                            <input type="text" id="search-articles" placeholder="üîç Rechercher..." style="padding: 0.5rem 1rem; border: 2px solid var(--gris-border); border-radius: 8px; width: 200px;" oninput="renderArticles()">
                        </div>
                        <div id="articles-list" class="cards-grid"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: COMMUNICATION -->
        <section class="tab-content" id="tab-communication">
            <!-- ABONN√âS NEWSLETTER -->
            <div class="card">
                <div class="card-header">
                    <h2>üìß Abonn√©s Newsletter</h2>
                    <div class="publish-bar">
                        <span class="status saved" id="status-abonnes">‚úì √Ä jour</span>
                        <button class="btn-publish" onclick="publish('abonnes')">üöÄ Publier</button>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="openAddAbonne()">+ Ajouter un abonn√©</button>
                        <button class="btn btn-outline" onclick="exportAbonnes()">üì• Exporter (CSV)</button>
                        <button class="btn btn-outline" onclick="document.getElementById('import-abonnes').click()">üì§ Importer</button>
                        <input type="file" id="import-abonnes" accept=".csv,.txt" style="display:none" onchange="importAbonnes(event)">
                    </div>
                    
                    <div style="background: #e8f4fc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <strong style="color: var(--bleu);">üìä Statistiques :</strong>
                        <span id="stats-abonnes">0 abonn√©s actifs</span>
                    </div>
                    
                    <div class="items-list">
                        <div class="items-header">
                            <h3>Liste des abonn√©s (<span id="abonnes-count">0</span>)</h3>
                            <input type="text" id="search-abonnes" placeholder="üîç Rechercher..." style="padding: 0.5rem 1rem; border: 2px solid var(--gris-border); border-radius: 8px; width: 200px;" oninput="renderAbonnes()">
                        </div>
                        <div id="abonnes-list"></div>
                    </div>
                </div>
            </div>

            <!-- PARTAGE FACEBOOK -->
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #1877f2 0%, #42b72a 100%);">
                    <h2>üìò Partage Facebook</h2>
                </div>
                <div class="card-body">
                    <p style="margin-bottom: 1rem; color: var(--gris-texte);">S√©lectionnez un article puis g√©n√©rez un post pr√™t √† copier-coller sur Facebook.</p>
                    
                    <div class="form-group">
                        <label>Choisir un article √† partager</label>
                        <select id="fb-article-select" onchange="previewFacebookPost()">
                            <option value="">-- S√©lectionnez un article --</option>
                        </select>
                    </div>
                    
                    <div id="fb-preview-zone" style="display: none;">
                        <div class="form-group">
                            <label>Texte du post (modifiable)</label>
                            <textarea id="fb-post-text" rows="5" style="font-size: 1rem;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="copyFacebookPost()" style="background: #1877f2;">
                                üìã Copier le texte
                            </button>
                            <button class="btn btn-outline" onclick="window.open('https://www.facebook.com/', '_blank')">
                                üìò Ouvrir Facebook
                            </button>
                        </div>
                        
                        <div style="background: #f0f2f5; padding: 1rem; border-radius: 8px; margin-top: 1.5rem;">
                            <strong style="color: #1877f2;">üí° Mode d'emploi :</strong>
                            <ol style="margin: 0.5rem 0 0 1.5rem; color: var(--gris-texte);">
                                <li>Cliquez sur "Copier le texte"</li>
                                <li>Ouvrez Facebook</li>
                                <li>Cr√©ez un nouveau post et collez (Ctrl+V)</li>
                                <li>Publiez !</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √âDITEUR NEWSLETTER -->
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #9b59b6 0%, #3498db 100%);">
                    <h2>üì¨ R√©diger la Newsletter</h2>
                </div>
                <div class="card-body">
                    <p style="margin-bottom: 1.5rem; color: var(--gris-texte);">Composez votre newsletter hebdomadaire. Le contenu sera pr√™t √† copier dans Brevo.</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Objet de l'email</label>
                            <input type="text" id="nl-objet" placeholder="Ex: Vizille en Mouvement - Actualit√©s de la semaine">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="nl-date">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Introduction</label>
                        <textarea id="nl-intro" rows="3" placeholder="Chers Vizillois, voici les actualit√©s de la semaine..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Contenu principal</label>
                        <textarea id="nl-contenu" rows="8" placeholder="- √âv√©nement 1&#10;- √âv√©nement 2&#10;- Actualit√© importante..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Appel √† l'action (optionnel)</label>
                        <input type="text" id="nl-cta" placeholder="Ex: Rejoignez-nous samedi √† 18h pour notre r√©union publique !">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="generateNewsletter()" style="background: #9b59b6;">
                            ‚ú® G√©n√©rer la newsletter
                        </button>
                        <button class="btn btn-outline" onclick="clearNewsletter()">
                            üóëÔ∏è Effacer
                        </button>
                    </div>
                    
                    <div id="nl-result" style="display: none; margin-top: 1.5rem;">
                        <div class="form-group">
                            <label>üìÑ Newsletter g√©n√©r√©e (pr√™te √† copier)</label>
                            <textarea id="nl-output" rows="12" readonly style="background: #f8f9fa; font-family: monospace;"></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="copyNewsletter()">
                                üìã Copier le contenu
                            </button>
                            <button class="btn btn-outline" onclick="copyAbonnesEmails()">
                                üìß Copier les emails des abonn√©s
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: PARAM√àTRES -->
        <section class="tab-content" id="tab-config">
            <div class="card">
                <div class="card-header">
                    <h2>‚öôÔ∏è Param√®tres du site</h2>
                    <div class="publish-bar">
                        <span class="status saved" id="status-config">‚úì √Ä jour</span>
                        <button class="btn-publish" onclick="publish('config')">üöÄ Publier</button>
                    </div>
                </div>
                <div class="card-body">
                    <h3 style="color: var(--bleu); margin-bottom: 1rem;">üìß Coordonn√©es</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email de contact</label>
                            <input type="email" id="config-email" placeholder="contact@Vizille-en-mouvement.fr" onchange="markModified('config')">
                        </div>
                        <div class="form-group">
                            <label>T√©l√©phone</label>
                            <input type="tel" id="config-telephone" placeholder="04 76 XX XX XX" onchange="markModified('config')">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Adresse / Lieu de permanence</label>
                        <input type="text" id="config-adresse" placeholder="Vizille, France" onchange="markModified('config')">
                    </div>

                    <h3 style="color: var(--bleu); margin: 2rem 0 1rem;">üì± R√©seaux sociaux</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>üìò Facebook (URL)</label>
                            <input type="url" id="config-facebook" placeholder="https://facebook.com/Vizilleenmouvement" onchange="markModified('config')">
                        </div>
                        <div class="form-group">
                            <label>üì∏ Instagram (URL)</label>
                            <input type="url" id="config-instagram" placeholder="https://instagram.com/Vizilleenmouvement" onchange="markModified('config')">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>üê¶ Twitter / X (URL)</label>
                            <input type="url" id="config-twitter" placeholder="https://twitter.com/Vizilleenmouvement" onchange="markModified('config')">
                        </div>
                        <div class="form-group">
                            <label>üîó Autre lien</label>
                            <input type="url" id="config-autre" placeholder="https://..." onchange="markModified('config')">
                        </div>
                    </div>

                    <h3 style="color: var(--bleu); margin: 2rem 0 1rem;">üïê Permanences</h3>
                    <div class="form-group">
                        <label>Informations sur les permanences</label>
                        <textarea id="config-permanences" rows="3" placeholder="Ex: Tous les samedis de 10h √† 12h √† la salle des f√™tes..." onchange="markModified('config')"></textarea>
                    </div>

                    <h3 style="color: var(--bleu); margin: 2rem 0 1rem;">üé® Personnalisation</h3>
                    <div class="form-group">
                        <label>Slogan</label>
                        <input type="text" id="config-slogan" placeholder="Vos questions pour une ville dynamique et solidaire" onchange="markModified('config')">
                    </div>

                    <h3 style="color: var(--bleu); margin: 2rem 0 1rem;">üîí Tranquillit√©</h3>
                    <div style="background: #fef3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="margin: 0; color: #856404;">‚ö†Ô∏è Le mot de passe est stock√© dans votre navigateur. Chaque utilisateur peut d√©finir le sien.</p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ancien mot de passe</label>
                            <input type="password" id="old-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <div class="form-group">
                            <label>Nouveau mot de passe</label>
                            <input type="password" id="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <div class="form-group">
                            <label>Confirmer</label>
                            <input type="password" id="confirm-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()">üîê Changer le mot de passe</button>
                </div>
            </div>
        </section>

    </main>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal-edit">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Modifier</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" id="modal-save">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const GITHUB_CONFIG = {
            owner: 'Vizilleenmouvement',
            repo: 'Vizille-en-mouvement',
            branch: 'main'
        };

        // Mot de passe par d√©faut hash√© (@@@@@ = 5 @)
        const DEFAULT_PASSWORD_HASH = 'YXQ0dml6aWxsZTIwMjY2NDczMTI5MDEx';
        
        // ===== AUTHENTIFICATION =====
        function simpleHash(str) {
            // Hash simple pour ne pas stocker en clair
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return btoa('at4' + str + hash + '1');
        }
        
        function checkPassword() {
            const input = document.getElementById('login-password').value;
            const storedHash = localStorage.getItem('vizille_admin_password') || DEFAULT_PASSWORD_HASH;
            const inputHash = simpleHash(input);
            
            if (inputHash === storedHash) {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('login-error').textContent = '';
                loadAllData();
            } else {
                document.getElementById('login-error').textContent = '‚ùå Mot de passe incorrect';
                document.getElementById('login-password').value = '';
            }
        }
        
        function changePassword() {
            const oldPwd = document.getElementById('old-password').value;
            const newPwd = document.getElementById('new-password').value;
            const confirmPwd = document.getElementById('confirm-password').value;
            
            // V√©rifier l'ancien mot de passe
            const storedHash = localStorage.getItem('vizille_admin_password') || DEFAULT_PASSWORD_HASH;
            if (simpleHash(oldPwd) !== storedHash) {
                showToast('‚ùå Ancien mot de passe incorrect', 'error');
                return;
            }
            
            // V√©rifier la confirmation
            if (newPwd !== confirmPwd) {
                showToast('‚ùå Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            // V√©rifier la longueur
            if (newPwd.length < 3) {
                showToast('‚ùå Mot de passe trop court (min 3 caract√®res)', 'error');
                return;
            }
            
            // Sauvegarder le nouveau mot de passe
            localStorage.setItem('vizille_admin_password', simpleHash(newPwd));
            
            // Vider les champs
            document.getElementById('old-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            
            showToast('‚úÖ Mot de passe chang√© !', 'success');
        }

        const THEMES_PROJETS = [
            { value: 'urbanisme', label: 'üèóÔ∏è Urbanisme' },
            { value: 'sante', label: 'üè• Sant√©' },
            { value: 'environnement', label: 'üå± Environnement' },
            { value: 'culture', label: 'üé≠ Culture' },
            { value: 'patrimoine', label: 'üèõÔ∏è Patrimoine' },
            { value: 'enfance', label: 'üë∂ Enfance' },
            { value: 'solidarite', label: 'ü§ù Solidarit√©' },
            { value: 'sport', label: '‚öΩ Sport' },
            { value: 'economie', label: 'üíº √âconomie' },
            { value: 'tranquillite', label: 'üõ°Ô∏è Tranquillit√©' },
            { value: 'mobilites', label: 'üö≤ Mobilit√©s' },
            { value: 'finances', label: 'üí∞ Finances' }
        ];

        const THEMES_ACTIONS = [
            { value: 'Urbanisme', label: 'üèóÔ∏è Urbanisme' },
            { value: 'Sant√©', label: 'üè• Sant√©' },
            { value: 'Environnement', label: 'üå± Environnement' },
            { value: 'Culture', label: 'üé≠ Culture' },
            { value: 'Patrimoine', label: 'üèõÔ∏è Patrimoine' },
            { value: 'Enfance', label: 'üë∂ Enfance' },
            { value: 'Solidarit√©', label: 'ü§ù Solidarit√©' },
            { value: 'Sport', label: '‚öΩ Sport' },
            { value: '√âconomie', label: 'üíº √âconomie' },
            { value: 'Tranquillit√©', label: 'üõ°Ô∏è Tranquillit√©' },
            { value: 'Mobilit√©s', label: 'üö≤ Mobilit√©s' },
            { value: 'Finance', label: 'üí∞ Finance' }
        ];

        // ===== DONN√âES =====
        let data = {
            projets: [],
            themes: [],
            actions: [],
            candidats: [],
            faq: [],
            articles: [],
            abonnes: [],
            config: {
                email: '',
                telephone: '',
                adresse: '',
                facebook: '',
                instagram: '',
                twitter: '',
                autre: '',
                permanences: '',
                slogan: 'Vos questions pour une ville dynamique et solidaire'
            }
        };

        let currentEdit = { type: null, index: null };
        let pendingPhoto = null;

        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', () => {
            setupTabs();
            loadToken();
            loadAllData();
        });

        function setupTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                });
            });
        }

        // ===== TOKEN =====
        function loadToken() {
            const saved = localStorage.getItem('vizille_github_token');
            if (saved) document.getElementById('github-token').value = saved;
        }

        function saveToken() {
            const token = document.getElementById('github-token').value;
            localStorage.setItem('vizille_github_token', token);
            showToast('üîê Token sauvegard√©', 'success');
        }

        function toggleToken() {
            const input = document.getElementById('github-token');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function getToken() {
            return document.getElementById('github-token').value;
        }

        // ===== CHARGEMENT DONN√âES =====
        async function loadAllData() {
            showToast('‚è≥ Chargement des donn√©es...', 'info');
            
            const files = {
                projets: 'projets.json',
                themes: 'themes.json',
                actions: 'data.json',
                candidats: 'candidats.json',
                faq: 'faq.json',
                articles: 'articles.json',
                abonnes: 'abonnes.json',
                config: 'config.json'
            };

            for (const [key, file] of Object.entries(files)) {
                setStatus(key, 'loading', '‚è≥...');
                try {
                    const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${file}`;
                    console.log(`Chargement de ${file}...`, url);
                    const response = await fetch(url);
                    if (response.ok) {
                        const loaded = await response.json();
                        if (key === 'config') {
                            data.config = { ...data.config, ...loaded };
                        } else if (key === 'themes') {
                            data.themes = loaded;
                            // Mettre √† jour THEMES_CONFIG depuis les donn√©es charg√©es
                            THEMES_CONFIG = [...loaded];
                        } else {
                            data[key] = loaded;
                        }
                        console.log(`‚úÖ ${file} charg√©:`, loaded.length !== undefined ? `${loaded.length} √©l√©ments` : 'OK');
                        setStatus(key, 'saved', '‚úì √Ä jour');
                    } else {
                        console.warn(`‚ö†Ô∏è ${file} - Erreur HTTP ${response.status}`);
                        setStatus(key, 'modified', `‚ö†Ô∏è Erreur ${response.status}`);
                    }
                } catch (err) {
                    console.error(`‚ùå ${file} - Erreur:`, err.message);
                    setStatus(key, 'modified', '‚ùå Erreur');
                }
            }

            renderAll();
            showToast('‚úÖ Donn√©es charg√©es !', 'success');
        }

        // ===== STATUS =====
        function setStatus(section, state, text) {
            const el = document.getElementById('status-' + section);
            if (el) {
                el.textContent = text;
                el.className = 'status ' + state;
            }
        }

        function markModified(section) {
            setStatus(section, 'modified', '‚ö†Ô∏è Modifi√©');
        }

        // ===== RENDER ALL =====
        function renderAll() {
            renderProjets();
            renderThemesList();
            renderActions();
            renderCandidats();
            renderFaq();
            renderArticles();
            renderAbonnes();
            renderFacebookSelect();
            renderConfig();
            initNewsletterDate();
            updateDashboard();
        }

        // ===== DASHBOARD =====
        function updateDashboard() {
            // Mise √† jour des statistiques
            const el = (id) => document.getElementById(id);
            if (el('stat-projets')) el('stat-projets').textContent = data.projets.length;
            if (el('stat-actions')) el('stat-actions').textContent = data.actions.length;
            if (el('stat-candidats')) el('stat-candidats').textContent = data.candidats.length;
            if (el('stat-articles')) el('stat-articles').textContent = data.articles.length;
            if (el('stat-themes')) el('stat-themes').textContent = data.themes.length;
            if (el('stat-abonnes')) el('stat-abonnes').textContent = data.abonnes.filter(a => a.actif !== false).length;

            // Derniers articles
            const recentArticles = [...data.articles]
                .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
                .slice(0, 3);

            const articlesHtml = recentArticles.length === 0
                ? '<p style="color: #888;">Aucun article</p>'
                : recentArticles.map(a => `
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid #eee; cursor: pointer;" onclick="switchTab('articles')">
                        <div style="font-weight: 500; color: var(--bleu);">${a.titre || 'Sans titre'}</div>
                        <div style="font-size: 0.8rem; color: #888;">${a.date || 'Sans date'} ${a.categorie ? '‚Ä¢ ' + a.categorie : ''}</div>
                    </div>
                `).join('');

            if (el('dashboard-recent-articles')) {
                el('dashboard-recent-articles').innerHTML = articlesHtml;
            }

            // R√©partition des actions par statut
            const actionsStats = {
                realise: data.actions.filter(a => a.statut === 'R√©alis√©' || a.statut === 'realise').length,
                encours: data.actions.filter(a => a.statut === 'En cours' || a.statut === 'encours').length,
                prevu: data.actions.filter(a => a.statut === 'Pr√©vu' || a.statut === 'prevu').length
            };

            const total = data.actions.length || 1;
            const actionsStatsHtml = `
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${(actionsStats.realise / total * 100).toFixed(0)}%; height: 100%; background: #27ae60;"></div>
                        </div>
                        <span style="font-size: 0.8rem; min-width: 70px;">‚úÖ ${actionsStats.realise} r√©alis√©es</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${(actionsStats.encours / total * 100).toFixed(0)}%; height: 100%; background: #f39c12;"></div>
                        </div>
                        <span style="font-size: 0.8rem; min-width: 70px;">üîÑ ${actionsStats.encours} en cours</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${(actionsStats.prevu / total * 100).toFixed(0)}%; height: 100%; background: #3498db;"></div>
                        </div>
                        <span style="font-size: 0.8rem; min-width: 70px;">üìã ${actionsStats.prevu} pr√©vues</span>
                    </div>
                </div>
            `;

            if (el('dashboard-actions-stats')) {
                el('dashboard-actions-stats').innerHTML = actionsStatsHtml;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabName);
            });
        }

        // ===== RECHERCHE GLOBALE =====
        function handleGlobalSearch(query) {
            const resultsContainer = document.getElementById('global-search-results');

            if (!query || query.length < 2) {
                resultsContainer.classList.remove('active');
                return;
            }

            const q = query.toLowerCase();
            const results = {
                projets: [],
                actions: [],
                candidats: [],
                articles: [],
                faq: []
            };

            // Recherche dans les projets
            data.projets.forEach((p, i) => {
                if ((p.titre || '').toLowerCase().includes(q) ||
                    (p.description || '').toLowerCase().includes(q)) {
                    results.projets.push({ ...p, index: i });
                }
            });

            // Recherche dans les actions
            data.actions.forEach((a, i) => {
                if ((a.titre || '').toLowerCase().includes(q) ||
                    (a.description || '').toLowerCase().includes(q)) {
                    results.actions.push({ ...a, index: i });
                }
            });

            // Recherche dans les candidats
            data.candidats.forEach((c, i) => {
                if ((c.nom || '').toLowerCase().includes(q) ||
                    (c.role || '').toLowerCase().includes(q) ||
                    (c.bio || '').toLowerCase().includes(q)) {
                    results.candidats.push({ ...c, index: i });
                }
            });

            // Recherche dans les articles
            data.articles.forEach((a, i) => {
                if ((a.titre || '').toLowerCase().includes(q) ||
                    (a.extrait || '').toLowerCase().includes(q) ||
                    (a.contenu || '').toLowerCase().includes(q)) {
                    results.articles.push({ ...a, index: i });
                }
            });

            // Recherche dans la FAQ
            data.faq.forEach((f, i) => {
                if ((f.question || '').toLowerCase().includes(q) ||
                    (f.reponse || '').toLowerCase().includes(q)) {
                    results.faq.push({ ...f, index: i });
                }
            });

            // G√©n√©rer le HTML des r√©sultats
            let html = '';
            const hasResults = Object.values(results).some(arr => arr.length > 0);

            if (!hasResults) {
                html = '<div style="padding: 1rem; text-align: center; color: #888;">Aucun r√©sultat pour "' + query + '"</div>';
            } else {
                if (results.projets.length > 0) {
                    html += `<div class="search-result-group">
                        <div class="search-result-group-title">üöÄ Projets (${results.projets.length})</div>
                        ${results.projets.slice(0, 3).map(p => `
                            <div class="search-result-item" onclick="goToResult('projets', ${p.index})">
                                <span class="icon">üöÄ</span>
                                <div>
                                    <div class="title">${p.titre || 'Sans titre'}</div>
                                    <div class="subtitle">${p.theme || ''}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }

                if (results.actions.length > 0) {
                    html += `<div class="search-result-group">
                        <div class="search-result-group-title">üìä Actions (${results.actions.length})</div>
                        ${results.actions.slice(0, 3).map(a => `
                            <div class="search-result-item" onclick="goToResult('actions', ${a.index})">
                                <span class="icon">üìä</span>
                                <div>
                                    <div class="title">${a.titre || 'Sans titre'}</div>
                                    <div class="subtitle">${a.theme || ''} ${a.statut ? '‚Ä¢ ' + a.statut : ''}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }

                if (results.candidats.length > 0) {
                    html += `<div class="search-result-group">
                        <div class="search-result-group-title">üë• Candidats (${results.candidats.length})</div>
                        ${results.candidats.slice(0, 3).map(c => `
                            <div class="search-result-item" onclick="goToResult('candidats', ${c.index})">
                                <span class="icon">üë§</span>
                                <div>
                                    <div class="title">${c.nom || 'Sans nom'}</div>
                                    <div class="subtitle">${c.role || ''}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }

                if (results.articles.length > 0) {
                    html += `<div class="search-result-group">
                        <div class="search-result-group-title">üì∞ Articles (${results.articles.length})</div>
                        ${results.articles.slice(0, 3).map(a => `
                            <div class="search-result-item" onclick="goToResult('articles', ${a.index})">
                                <span class="icon">üì∞</span>
                                <div>
                                    <div class="title">${a.titre || 'Sans titre'}</div>
                                    <div class="subtitle">${a.date || ''} ${a.categorie ? '‚Ä¢ ' + a.categorie : ''}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }

                if (results.faq.length > 0) {
                    html += `<div class="search-result-group">
                        <div class="search-result-group-title">‚ùì FAQ (${results.faq.length})</div>
                        ${results.faq.slice(0, 3).map(f => `
                            <div class="search-result-item" onclick="goToResult('faq', ${f.index})">
                                <span class="icon">‚ùì</span>
                                <div>
                                    <div class="title">${f.question || 'Sans question'}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }
            }

            resultsContainer.innerHTML = html;
            resultsContainer.classList.add('active');
        }

        function goToResult(type, index) {
            // Fermer les r√©sultats
            document.getElementById('global-search-results').classList.remove('active');
            document.getElementById('global-search').value = '';

            // Aller √† l'onglet appropri√©
            switchTab(type);

            // Ouvrir l'√©diteur selon le type
            setTimeout(() => {
                switch (type) {
                    case 'projets':
                        openEditProjet(index);
                        break;
                    case 'actions':
                        openEditAction(index);
                        break;
                    case 'candidats':
                        openEditCandidat(index);
                        break;
                    case 'articles':
                        openEditArticle(index);
                        break;
                    case 'faq':
                        openEditFaq(index);
                        break;
                }
            }, 100);
        }

        // Fermer les r√©sultats quand on clique ailleurs
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.global-search-container');
            if (searchContainer && !searchContainer.contains(e.target)) {
                document.getElementById('global-search-results').classList.remove('active');
            }
        });

        function getThemeLabel(themes, value) {
            const t = themes.find(t => t.value === value);
            return t ? t.label : value;
        }

        // ===== PROJETS =====
        let currentProjetFilter = '';
        
        function filterProjets(theme) {
            currentProjetFilter = theme;
            // Mettre √† jour les boutons actifs
            document.querySelectorAll('#projet-theme-filters .theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
            renderProjets();
        }
        
        function updateProjetCounts() {
            // Compter les projets par th√®me (directement depuis les donn√©es)
            const counts = {};
            data.projets.forEach(p => {
                const theme = (p.theme || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                counts[theme] = (counts[theme] || 0) + 1;
            });
            
            // Mettre √† jour le compteur total
            const allEl = document.getElementById('pcount-all');
            if (allEl) allEl.textContent = data.projets.length;
            
            // Mettre √† jour les compteurs par th√®me
            document.querySelectorAll('[id^="pcount-"]').forEach(el => {
                const theme = el.id.replace('pcount-', '');
                if (theme !== 'all') {
                    el.textContent = counts[theme] || 0;
                }
            });
        }
        
        // Variable pour suivre le th√®me actuellement affich√© en d√©tail
        let currentProjetThemeDetail = null;

        function renderProjets() {
            updateProjetCounts();

            const search = (document.getElementById('search-projets')?.value || '').toLowerCase();

            // Si recherche active ou filtre th√®me via boutons, afficher directement les cartes
            if (search || currentProjetFilter) {
                showProjetsCards(search);
                return;
            }

            // Si un th√®me est s√©lectionn√© en d√©tail, afficher ses projets
            if (currentProjetThemeDetail) {
                showProjetThemeDetail(currentProjetThemeDetail);
                return;
            }

            // Sinon, afficher la vue par th√®mes
            showProjetsThemesView();
        }

        function showProjetsThemesView() {
            document.getElementById('projets-themes-view').style.display = 'grid';
            document.getElementById('projets-detail-view').style.display = 'none';

            // Grouper les projets par th√®me principal
            const themeGroups = {};
            data.projets.forEach(p => {
                const themes = getProjetThemes(p);
                const primaryTheme = themes[0] || 'Non d√©fini';
                if (!themeGroups[primaryTheme]) {
                    themeGroups[primaryTheme] = [];
                }
                themeGroups[primaryTheme].push(p);
            });

            document.getElementById('projets-count').textContent = data.projets.length;

            // Trier les th√®mes par nombre de projets
            const sortedThemes = Object.entries(themeGroups).sort((a, b) => b[1].length - a[1].length);

            document.getElementById('projets-themes-view').innerHTML = sortedThemes.length === 0
                ? '<div class="empty-state" style="grid-column: 1/-1;"><div class="icon">üì≠</div><p>Aucun projet</p></div>'
                : sortedThemes.map(([themeName, projets]) => {
                    const themeConf = THEMES_CONFIG.find(t => t.theme === themeName) || { icon: 'üìã', color: '#1a3a5c' };
                    const prioritaires = projets.filter(p => p.statut === 'Prioritaire').length;

                    return `
                    <div class="theme-card" onclick="showProjetThemeDetail('${themeName}')">
                        <div class="theme-card-header" style="background: ${themeConf.color}">
                            <span class="theme-card-icon">${themeConf.icon}</span>
                            <div class="theme-card-info">
                                <h3>${themeName}</h3>
                                <span class="count">${projets.length} projet${projets.length > 1 ? 's' : ''}</span>
                            </div>
                        </div>
                        <div class="theme-card-stats">
                            <span>${prioritaires > 0 ? 'üî¥ ' + prioritaires + ' prioritaire(s)' : 'Cliquer pour voir'}</span>
                            <span class="theme-card-arrow">‚Üí</span>
                        </div>
                    </div>
                `}).join('');
        }

        function showProjetThemeDetail(themeName) {
            currentProjetThemeDetail = themeName;
            document.getElementById('projets-themes-view').style.display = 'none';
            document.getElementById('projets-detail-view').style.display = 'block';

            const themeConf = THEMES_CONFIG.find(t => t.theme === themeName) || { icon: 'üìã', color: '#1a3a5c' };

            // Filtrer les projets de ce th√®me
            const projets = data.projets.filter(p => {
                const themes = getProjetThemes(p);
                return themes.includes(themeName);
            });

            document.getElementById('projets-count').textContent = projets.length;

            document.getElementById('projets-detail-view').innerHTML = `
                <div class="theme-detail">
                    <div class="theme-detail-header">
                        <div class="theme-detail-title">
                            <span style="font-size: 1.5rem;">${themeConf.icon}</span>
                            <span>${themeName}</span>
                            <span style="color: #888; font-weight: normal; font-size: 1rem;">(${projets.length} projet${projets.length > 1 ? 's' : ''})</span>
                        </div>
                        <button class="btn-back-theme" onclick="backToProjetsThemes()">‚Üê Retour aux th√®mes</button>
                    </div>
                    <div class="cards-grid">
                        ${projets.map(p => renderProjetCard(p)).join('')}
                    </div>
                </div>
            `;
        }

        function backToProjetsThemes() {
            currentProjetThemeDetail = null;
            currentProjetFilter = '';
            document.querySelectorAll('#tab-projets .theme-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#tab-projets .theme-btn')?.classList.add('active');
            renderProjets();
        }

        function showProjetsCards(search) {
            document.getElementById('projets-themes-view').style.display = 'none';
            document.getElementById('projets-detail-view').style.display = 'block';

            let filtered = data.projets;

            // Filtre par th√®me
            if (currentProjetFilter) {
                filtered = filtered.filter(p => {
                    const themes = getProjetThemes(p);
                    return themes.some(t => t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes(currentProjetFilter.toLowerCase()));
                });
            }

            // Filtre par recherche
            if (search) {
                filtered = filtered.filter(p => {
                    const themesStr = getProjetThemes(p).join(' ').toLowerCase();
                    return (p.titre || '').toLowerCase().includes(search) ||
                        themesStr.includes(search) ||
                        (p.resume || '').toLowerCase().includes(search) ||
                        (p.description || '').toLowerCase().includes(search);
                });
            }

            document.getElementById('projets-count').textContent = filtered.length;

            document.getElementById('projets-detail-view').innerHTML = `
                <div class="theme-detail">
                    <div class="theme-detail-header">
                        <div class="theme-detail-title">
                            <span>üîç R√©sultats</span>
                            <span style="color: #888; font-weight: normal; font-size: 1rem;">(${filtered.length} projet${filtered.length > 1 ? 's' : ''})</span>
                        </div>
                        <button class="btn-back-theme" onclick="backToProjetsThemes()">‚Üê Retour aux th√®mes</button>
                    </div>
                    <div class="cards-grid">
                        ${filtered.length === 0
                            ? '<div class="empty-state" style="grid-column: 1/-1;"><div class="icon">üì≠</div><p>Aucun projet trouv√©</p></div>'
                            : filtered.map(p => renderProjetCard(p)).join('')}
                    </div>
                </div>
            `;
        }

        function renderProjetCard(p) {
            const themes = getProjetThemes(p);
            const primaryTheme = themes[0] || 'Non d√©fini';
            const themeConf = THEMES_CONFIG.find(t => t.theme === primaryTheme) || { icon: 'üìã', color: '#1a3a5c' };
            const statutClass = (p.statut || '').toLowerCase().replace(/\s+/g, '-').replace('√©', 'e');

            return `
                <div class="admin-card">
                    <div class="admin-card-header">
                        <span class="admin-card-theme" style="background: ${themeConf.color}">
                            ${themeConf.icon} ${primaryTheme}
                        </span>
                        <span class="admin-card-statut statut-${statutClass}">${p.statut || 'Non d√©fini'}</span>
                    </div>
                    <div class="admin-card-body">
                        <div class="admin-card-title">${p.titre || 'Sans titre'}</div>
                        <div class="admin-card-desc">${p.resume || p.description || ''}</div>
                        <div class="admin-card-footer">
                            <span class="admin-card-meta">${p.annee || ''}</span>
                            <div class="admin-card-actions">
                                <button class="btn btn-sm btn-primary" onclick="openEditProjet(${data.projets.indexOf(p)})">‚úèÔ∏è Modifier</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProjet(${data.projets.indexOf(p)})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function openAddProjet() {
            currentEdit = { type: 'projet', index: -1 };
            showProjetModal({});
        }

        function openEditProjet(index) {
            currentEdit = { type: 'projet', index };
            showProjetModal(data.projets[index]);
        }

        // Configuration des th√®mes par d√©faut (sera remplac√©e par themes.json au chargement)
        let THEMES_CONFIG = [
            { theme: 'Urbanisme', icon: 'üèòÔ∏è', color: '#34495e' },
            { theme: 'Environnement', icon: 'üåø', color: '#27ae60' },
            { theme: 'Solidarit√©', icon: 'ü§ù', color: '#e74c3c' },
            { theme: 'Sant√©', icon: 'üè•', color: '#e91e63' },
            { theme: 'Enfance', icon: 'üë∂', color: '#3498db' },
            { theme: 'Culture', icon: 'üé≠', color: '#9b59b6' },
            { theme: 'Sport', icon: '‚öΩ', color: '#4caf50' },
            { theme: '√âconomie', icon: 'üíº', color: '#f39c12' },
            { theme: 'Tranquillit√©', icon: 'üõ°Ô∏è', color: '#2c3e50' },
            { theme: 'Mobilit√©s', icon: 'üö¥', color: '#1abc9c' },
            { theme: 'Seniors', icon: 'üë¥', color: '#795548' },
            { theme: 'D√©mocratie locale', icon: 'üó£Ô∏è', color: '#607d8b' },
            { theme: 'M√©tropole', icon: 'üèõÔ∏è', color: '#00bcd4' }
        ];
        
        // ===== GESTION DES TH√àMES =====
        function renderThemesList() {
            // Compter les projets par th√®me
            const themeCounts = {};
            (data.projets || []).forEach(p => {
                const themes = getProjetThemes(p);
                themes.forEach(t => {
                    themeCounts[t] = (themeCounts[t] || 0) + 1;
                });
            });
            
            document.getElementById('themes-count').textContent = THEMES_CONFIG.length;

            // Trier par nombre de projets d√©croissant
            const sortedThemes = [...THEMES_CONFIG].map((t, originalIndex) => ({
                ...t,
                originalIndex,
                count: themeCounts[t.theme] || 0
            })).sort((a, b) => b.count - a.count);

            const container = document.getElementById('themes-list');
            container.innerHTML = sortedThemes.length === 0
                ? '<div class="empty-state" style="grid-column: 1/-1;"><div class="icon">üé®</div><p>Aucun th√®me</p></div>'
                : sortedThemes.map((t) => {
                    const hasProjects = t.count > 0;
                    return `
                    <div class="theme-card" style="cursor: default;">
                        <div class="theme-card-header" style="background: ${t.color}">
                            <span class="theme-card-icon">${t.icon}</span>
                            <div class="theme-card-info">
                                <h3>${t.theme}</h3>
                                <span class="count">${t.count} projet${t.count > 1 ? 's' : ''}</span>
                            </div>
                        </div>
                        <div class="theme-card-stats" style="justify-content: flex-end;">
                            <button class="btn btn-sm btn-danger"
                                    onclick="deleteTheme(${t.originalIndex})"
                                    title="${hasProjects ? 'Supprimer et r√©assigner les projets' : 'Supprimer ce th√®me'}">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function addNewTheme() {
            const nameInput = document.getElementById('new-theme-name');
            const iconSelect = document.getElementById('new-theme-icon');
            const colorInput = document.getElementById('new-theme-color');
            
            const name = nameInput.value.trim();
            const icon = iconSelect.value;
            const color = colorInput.value;
            
            if (!name) {
                showToast('‚ö†Ô∏è Veuillez entrer un nom de th√®me', 'warning');
                return;
            }
            
            if (THEMES_CONFIG.some(t => t.theme.toLowerCase() === name.toLowerCase())) {
                showToast('‚ö†Ô∏è Ce th√®me existe d√©j√†', 'warning');
                return;
            }
            
            THEMES_CONFIG.push({ theme: name, icon, color });
            THEMES_CONFIG.sort((a, b) => a.theme.localeCompare(b.theme));
            data.themes = [...THEMES_CONFIG];
            markModified('themes');
            
            // R√©initialiser le formulaire
            nameInput.value = '';
            iconSelect.value = 'üìå';
            colorInput.value = '#1a3a5c';
            
            renderThemesList();
            showToast('‚úÖ Th√®me ajout√© : ' + name + ' (pensez √† publier)', 'success');
        }
        
        function deleteTheme(index) {
            const theme = THEMES_CONFIG[index];
            
            // Compter les projets qui utilisent ce th√®me
            const projetsWithTheme = (data.projets || []).filter(p => {
                const themes = getProjetThemes(p);
                return themes.includes(theme.theme);
            });
            
            if (projetsWithTheme.length > 0) {
                // Afficher la modal de r√©assignation
                showReassignModal(index, theme, projetsWithTheme.length);
                return;
            }
            
            // Pas de projets, suppression directe
            if (!confirm(`Supprimer le th√®me "${theme.theme}" ?`)) {
                return;
            }
            
            THEMES_CONFIG.splice(index, 1);
            data.themes = [...THEMES_CONFIG];
            markModified('themes');
            
            renderThemesList();
            showToast('‚úÖ Th√®me supprim√© (pensez √† publier)', 'success');
        }
        
        function showReassignModal(themeIndex, theme, projetCount) {
            // Cr√©er les options pour le select (tous les th√®mes sauf celui √† supprimer)
            const otherThemes = THEMES_CONFIG.filter((t, i) => i !== themeIndex);
            const options = otherThemes.map(t => 
                `<option value="${t.theme}">${t.icon} ${t.theme}</option>`
            ).join('');
            
            // Cr√©er la modal
            const modalHTML = `
                <div id="reassign-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <h3 style="color: var(--bleu); margin-bottom: 1rem;">üîÑ R√©assigner les projets</h3>
                        <p style="color: #666; margin-bottom: 1.5rem;">
                            <strong>${projetCount} projet${projetCount > 1 ? 's' : ''}</strong> utilise${projetCount > 1 ? 'nt' : ''} le th√®me <strong style="color: ${theme.color};">${theme.icon} ${theme.theme}</strong>.
                        </p>
                        <p style="color: #666; margin-bottom: 1rem;">Vers quel th√®me souhaitez-vous les d√©placer ?</p>
                        <select id="reassign-target" style="width: 100%; padding: 10px; border: 2px solid var(--gris-border); border-radius: 8px; font-size: 1rem; margin-bottom: 1.5rem;">
                            ${options}
                        </select>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn" onclick="closeReassignModal()" style="background: #e0e0e0; color: #666;">Annuler</button>
                            <button class="btn btn-primary" onclick="confirmReassign(${themeIndex}, '${theme.theme}')">R√©assigner et supprimer</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeReassignModal() {
            const modal = document.getElementById('reassign-modal');
            if (modal) modal.remove();
        }
        
        function confirmReassign(themeIndex, oldThemeName) {
            const newTheme = document.getElementById('reassign-target').value;
            
            // R√©assigner tous les projets
            let reassigned = 0;
            (data.projets || []).forEach(p => {
                const themes = getProjetThemes(p);
                const idx = themes.indexOf(oldThemeName);
                if (idx !== -1) {
                    // Remplacer l'ancien th√®me par le nouveau
                    themes[idx] = newTheme;
                    // Supprimer les doublons si le nouveau th√®me √©tait d√©j√† pr√©sent
                    p.themes = [...new Set(themes)];
                    p.theme = p.themes[0]; // R√©trocompatibilit√©
                    reassigned++;
                }
            });
            
            // Supprimer le th√®me
            THEMES_CONFIG.splice(themeIndex, 1);
            data.themes = [...THEMES_CONFIG];
            
            // Marquer comme modifi√©
            markModified('themes');
            markModified('projets');
            
            closeReassignModal();
            renderThemesList();
            renderProjets();
            
            showToast(`‚úÖ ${reassigned} projet${reassigned > 1 ? 's' : ''} r√©assign√©${reassigned > 1 ? 's' : ''} vers "${newTheme}" (pensez √† publier)`, 'success');
        }

        // Helper pour obtenir les th√®mes d'un projet (supporte theme ou themes)
        function getProjetThemes(p) {
            if (p.themes && Array.isArray(p.themes)) {
                return p.themes;
            }
            return p.theme ? [p.theme] : [];
        }
        
        // Toggle un badge de th√®me (s√©lection/d√©s√©lection)
        function toggleThemeBadge(el) {
            const isSelected = el.classList.contains('selected');
            const color = el.dataset.color;
            
            if (isSelected) {
                el.classList.remove('selected');
                el.style.background = '#e0e0e0';
                el.style.color = '#666';
                el.style.borderColor = 'transparent';
            } else {
                el.classList.add('selected');
                el.style.background = color;
                el.style.color = 'white';
                el.style.borderColor = color;
            }
        }

        function showProjetModal(p) {
            document.getElementById('modal-title').textContent = currentEdit.index === -1 ? '‚ûï Ajouter un projet' : '‚úèÔ∏è Modifier le projet';
            
            const currentThemes = getProjetThemes(p);
            const themeBadges = THEMES_CONFIG.map(t => {
                const isSelected = currentThemes.includes(t.theme);
                return `<span class="theme-badge-select ${isSelected ? 'selected' : ''}" 
                              data-theme="${t.theme}" 
                              data-color="${t.color}"
                              onclick="toggleThemeBadge(this)"
                              style="background: ${isSelected ? t.color : '#e0e0e0'}; 
                                     color: ${isSelected ? 'white' : '#666'}; 
                                     padding: 6px 12px; 
                                     border-radius: 20px; 
                                     font-size: 0.85rem; 
                                     cursor: pointer; 
                                     margin: 4px;
                                     display: inline-block;
                                     transition: all 0.2s ease;
                                     border: 2px solid ${isSelected ? t.color : 'transparent'};">
                        ${t.icon} ${t.theme}
                       </span>`;
            }).join('');
            
            const statutOptions = ['Programm√©', 'En cours', 'Prioritaire', '√âtude'].map(s =>
                `<option value="${s}" ${p.statut === s ? 'selected' : ''}>${s}</option>`
            ).join('');
            
            // Pr√©parer les chiffres existants
            const chiffresHTML = (p.chiffres || []).map((c, i) => `
                <div class="chiffre-row" style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" class="chiffre-valeur" value="${c.valeur || ''}" placeholder="Ex: 150 000 ‚Ç¨">
                    <input type="text" class="chiffre-label" value="${c.label || ''}" placeholder="Ex: Budget total">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                </div>
            `).join('');
            
            // Pr√©parer la chronologie existante
            const chronoHTML = (p.chronologie || []).map((c, i) => `
                <div class="chrono-row" style="display: grid; grid-template-columns: 120px 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" class="chrono-date" value="${c.date || ''}" placeholder="Ex: 2027">
                    <input type="text" class="chrono-event" value="${c.evenement || ''}" placeholder="Ex: Lancement des travaux">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                </div>
            `).join('');
            
            // Pr√©parer les documents existants
            const docsHTML = (p.documents || []).map((d, i) => `
                <div class="doc-row" style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" class="doc-nom" value="${d.nom || ''}" placeholder="Nom du document">
                    <input type="text" class="doc-url" value="${d.url || ''}" placeholder="URL ou chemin">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                </div>
            `).join('');
            
            // Pr√©parer les images existantes
            const imagesHTML = (p.images || []).map((img, i) => `
                <div class="img-row" style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" class="img-url" value="${img.url || ''}" placeholder="URL de l'image">
                    <input type="text" class="img-alt" value="${img.alt || ''}" placeholder="Description">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                </div>
            `).join('');
            
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label>Titre du projet *</label>
                    <input type="text" id="edit-titre" value="${p.titre || ''}" placeholder="Ex: Cr√©ation d'une maison de sant√©">
                </div>
                <div class="form-group">
                    <label>Th√®me(s) * <small style="color: #888; font-weight: normal;">(cliquer pour s√©lectionner)</small></label>
                    <div id="themes-badges" style="display: flex; flex-wrap: wrap; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid var(--gris-border);">
                        ${themeBadges}
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Statut</label>
                        <select id="edit-statut">
                            ${statutOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ann√©e pr√©vue</label>
                        <select id="edit-annee">
                            <option value="">--</option>
                            ${[2026, 2027, 2028, 2029, 2030, 2031, 2032].map(a => 
                                `<option value="${a}" ${p.annee == a ? 'selected' : ''}>${a}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Importance (1-3)</label>
                        <select id="edit-importance">
                            <option value="1" ${p.importance == 1 ? 'selected' : ''}>1 - Normal</option>
                            <option value="2" ${p.importance == 2 ? 'selected' : ''}>2 - Important</option>
                            <option value="3" ${p.importance == 3 ? 'selected' : ''}>3 - Prioritaire</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Budget estim√© (‚Ç¨)</label>
                        <input type="number" id="edit-budget" value="${p.budget || 0}" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>R√©sum√© court</label>
                    <input type="text" id="edit-resume" value="${p.resume || ''}" placeholder="Ex: Acc√®s aux soins pour tous">
                </div>
                <div class="form-group">
                    <label>Description d√©taill√©e</label>
                    <textarea id="edit-description" rows="4" placeholder="Description compl√®te du projet...">${p.description || ''}</textarea>
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid var(--or);">
                <h4 style="color: var(--bleu); margin-bottom: 1rem;">üñºÔ∏è Illustration</h4>

                <div class="form-group">
                    <label>Image principale</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="edit-image" value="${p.image || ''}" placeholder="Chemin de l'image" style="flex: 1; min-width: 200px;">
                        <label class="btn btn-outline btn-sm" style="cursor: pointer; margin: 0;">
                            üìÅ Importer
                            <input type="file" id="import-image" accept="image/*" onchange="handleImageImport(this)" style="display: none;">
                        </label>
                    </div>
                    <div id="image-preview" style="margin-top: 0.5rem; ${p.image ? '' : 'display: none;'}">
                        <img src="${p.image || ''}" style="max-width: 150px; max-height: 100px; border-radius: 8px; border: 1px solid var(--gris-border);">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Galerie d'images</label>
                    <div id="images-container">${imagesHTML}</div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addImageRow()" style="margin-top: 0.5rem;">+ Ajouter une image</button>
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid var(--or);">
                <h4 style="color: var(--bleu); margin-bottom: 1rem;">üìä Objectifs chiffr√©s</h4>
                
                <div class="form-group">
                    <label>Chiffres cl√©s</label>
                    <div id="chiffres-container">${chiffresHTML}</div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addChiffreRow()" style="margin-top: 0.5rem;">+ Ajouter un chiffre</button>
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid var(--or);">
                <h4 style="color: var(--bleu); margin-bottom: 1rem;">üìÖ Calendrier pr√©visionnel</h4>
                
                <div class="form-group">
                    <label>√âtapes du projet</label>
                    <div id="chrono-container">${chronoHTML}</div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addChronoRow()" style="margin-top: 0.5rem;">+ Ajouter une √©tape</button>
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid var(--or);">
                <h4 style="color: var(--bleu); margin-bottom: 1rem;">üìé Documents joints</h4>
                
                <div class="form-group">
                    <label>Documents (PDF, √©tudes, plans...)</label>
                    <div id="docs-container">${docsHTML}</div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addDocRow()" style="margin-top: 0.5rem;">+ Ajouter un document</button>
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid var(--or);">
                <h4 style="color: var(--bleu); margin-bottom: 1rem;">üéØ Fiche Objectif (Mobilit√©s)</h4>

                <div class="form-group">
                    <label>Slogan <small style="color: #888;">(ex: Relier ‚Ä¢ Diversifier ‚Ä¢ Anticiper)</small></label>
                    <input type="text" id="edit-slogan" value="${p.slogan || ''}" placeholder="Ex: Prot√©ger ‚Ä¢ Faciliter ‚Ä¢ Rassurer">
                </div>

                <div class="form-group">
                    <label>Num√©ro d'objectif <small style="color: #888;">(ex: 1/7)</small></label>
                    <input type="text" id="edit-numero" value="${p.numero || ''}" placeholder="Ex: 1/7">
                </div>

                <div class="form-group">
                    <label>Tags <small style="color: #888;">(s√©par√©s par des virgules)</small></label>
                    <input type="text" id="edit-tags" value="${(p.tags || []).join(', ')}" placeholder="Ex: S√©curit√©, Accessibilit√©, Confort">
                </div>

                <div class="form-group">
                    <label>Enjeux <small style="color: #888;">(un par ligne)</small></label>
                    <textarea id="edit-enjeux" rows="3" placeholder="R√©duire la d√©pendance √† la voiture&#10;Offrir des alternatives cr√©dibles&#10;Anticiper les besoins futurs">${(p.enjeux || []).join('\n')}</textarea>
                </div>

                <div class="form-group">
                    <label>Axes d'action <small style="color: #888;">(un par ligne)</small></label>
                    <textarea id="edit-axes" rows="4" placeholder="Navettes adapt√©es aux horaires&#10;Covoiturage et parkings relais&#10;Sc√©narios transport par c√¢ble">${(p.axes_action || []).join('\n')}</textarea>
                </div>

                <div class="form-group">
                    <label>Indicateurs <small style="color: #888;">(s√©par√©s par des virgules)</small></label>
                    <input type="text" id="edit-indicateurs" value="${(p.indicateurs || []).join(', ')}" placeholder="Ex: √âtudes engag√©es, Partenaires mobilis√©s, Usage des alternatives">
                </div>

                <div class="form-group">
                    <label>Vision</label>
                    <textarea id="edit-vision" rows="2" placeholder="Ex: Aucune hypoth√®se n'est √©cart√©e pour connecter Vizille au territoire.">${p.vision || ''}</textarea>
                </div>

                <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid var(--or);">
                <h4 style="color: var(--bleu); margin-bottom: 1rem;">üìù Informations compl√©mentaires</h4>

                <div class="form-group">
                    <label>D√©tails suppl√©mentaires</label>
                    <textarea id="edit-details" rows="3" placeholder="Informations compl√©mentaires, contexte, partenaires...">${p.details || ''}</textarea>
                </div>
            `;
            document.getElementById('modal-save').onclick = saveProjet;
            document.getElementById('modal-edit').classList.add('active');
        }
        
        // Fonctions pour ajouter des lignes dynamiquement
        function addChiffreRow() {
            const container = document.getElementById('chiffres-container');
            const row = document.createElement('div');
            row.className = 'chiffre-row';
            row.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr auto; gap: 0.5rem; margin-bottom: 0.5rem;';
            row.innerHTML = `
                <input type="text" class="chiffre-valeur" placeholder="Ex: 150 000 ‚Ç¨">
                <input type="text" class="chiffre-label" placeholder="Ex: Budget total">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(row);
        }
        
        function addChronoRow() {
            const container = document.getElementById('chrono-container');
            const row = document.createElement('div');
            row.className = 'chrono-row';
            row.style.cssText = 'display: grid; grid-template-columns: 120px 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem;';
            row.innerHTML = `
                <input type="text" class="chrono-date" placeholder="Ex: 2027">
                <input type="text" class="chrono-event" placeholder="Ex: Lancement des travaux">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(row);
        }
        
        function addDocRow() {
            const container = document.getElementById('docs-container');
            const row = document.createElement('div');
            row.className = 'doc-row';
            row.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr auto; gap: 0.5rem; margin-bottom: 0.5rem;';
            row.innerHTML = `
                <input type="text" class="doc-nom" placeholder="Nom du document">
                <input type="text" class="doc-url" placeholder="URL ou chemin">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(row);
        }

        // Gestion de l'import d'image
        function handleImageImport(input) {
            const file = input.files[0];
            if (!file) return;

            // G√©n√©rer un nom de fichier propre
            const fileName = file.name.replace(/\s+/g, '_').toLowerCase();
            const imagePath = 'images/objectifs/' + fileName;

            // Mettre √† jour le champ texte
            document.getElementById('edit-image').value = imagePath;

            // Afficher la pr√©visualisation
            const preview = document.getElementById('image-preview');
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" style="max-width: 150px; max-height: 100px; border-radius: 8px; border: 1px solid var(--gris-border);">`;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Stocker le fichier pour upload ult√©rieur
            window.pendingImageFile = file;
            window.pendingImagePath = imagePath;

            showToast('üìÅ Image s√©lectionn√©e : ' + fileName + '\\n‚ö†Ô∏è Placez le fichier dans images/projets/', 'info');
        }
        
        function addImageRow() {
            const container = document.getElementById('images-container');
            const row = document.createElement('div');
            row.className = 'img-row';
            row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem;';
            row.innerHTML = `
                <input type="text" class="img-url" placeholder="URL de l'image">
                <input type="text" class="img-alt" placeholder="Description">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(row);
        }

        function updateThemePreview() {
            // Plus n√©cessaire avec le nouveau formulaire
        }

        function saveProjet() {
            const titre = document.getElementById('edit-titre').value.trim();
            
            // R√©cup√©rer les th√®mes s√©lectionn√©s (badges)
            const themes = [];
            document.querySelectorAll('#themes-badges .theme-badge-select.selected').forEach(badge => {
                themes.push(badge.dataset.theme);
            });
            
            const statut = document.getElementById('edit-statut').value;
            const annee = parseInt(document.getElementById('edit-annee').value) || null;
            const importance = parseInt(document.getElementById('edit-importance').value) || 1;
            const resume = document.getElementById('edit-resume').value.trim();
            const description = document.getElementById('edit-description').value.trim();
            const budget = parseInt(document.getElementById('edit-budget').value) || 0;
            
            // Nouveaux champs
            const image = document.getElementById('edit-image').value.trim();
            const details = document.getElementById('edit-details').value.trim();
            
            // R√©cup√©rer les chiffres
            const chiffres = [];
            document.querySelectorAll('#chiffres-container .chiffre-row').forEach(row => {
                const valeur = row.querySelector('.chiffre-valeur').value.trim();
                const label = row.querySelector('.chiffre-label').value.trim();
                if (valeur || label) {
                    chiffres.push({ valeur, label });
                }
            });
            
            // R√©cup√©rer la chronologie
            const chronologie = [];
            document.querySelectorAll('#chrono-container .chrono-row').forEach(row => {
                const date = row.querySelector('.chrono-date').value.trim();
                const evenement = row.querySelector('.chrono-event').value.trim();
                if (date || evenement) {
                    chronologie.push({ date, evenement });
                }
            });
            
            // R√©cup√©rer les documents
            const documents = [];
            document.querySelectorAll('#docs-container .doc-row').forEach(row => {
                const nom = row.querySelector('.doc-nom').value.trim();
                const url = row.querySelector('.doc-url').value.trim();
                if (nom || url) {
                    documents.push({ nom, url });
                }
            });
            
            // R√©cup√©rer les images de la galerie
            const images = [];
            document.querySelectorAll('#images-container .img-row').forEach(row => {
                const url = row.querySelector('.img-url').value.trim();
                const alt = row.querySelector('.img-alt').value.trim();
                if (url) {
                    images.push({ url, alt });
                }
            });

            // R√©cup√©rer les champs Fiche Objectif
            const slogan = document.getElementById('edit-slogan').value.trim();
            const numero = document.getElementById('edit-numero').value.trim();
            const tagsInput = document.getElementById('edit-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
            const enjeuxInput = document.getElementById('edit-enjeux').value.trim();
            const enjeux = enjeuxInput ? enjeuxInput.split('\n').map(e => e.trim()).filter(e => e) : [];
            const axesInput = document.getElementById('edit-axes').value.trim();
            const axes_action = axesInput ? axesInput.split('\n').map(a => a.trim()).filter(a => a) : [];
            const indicateursInput = document.getElementById('edit-indicateurs').value.trim();
            const indicateurs = indicateursInput ? indicateursInput.split(',').map(i => i.trim()).filter(i => i) : [];
            const vision = document.getElementById('edit-vision').value.trim();

            if (!titre || themes.length === 0) {
                showToast('‚ö†Ô∏è Titre et au moins un th√®me obligatoires', 'warning');
                return;
            }

            const projet = {
                id: currentEdit.index === -1 ? Date.now() : data.projets[currentEdit.index].id,
                titre,
                themes,  // tableau de th√®mes
                theme: themes[0],  // r√©trocompatibilit√© : premier th√®me
                statut,
                annee,
                budget,
                resume,
                description,
                importance,
                image,
                images,
                chiffres,
                chronologie,
                documents,
                details,
                // Champs Fiche Objectif
                slogan,
                numero,
                tags,
                enjeux,
                axes_action,
                indicateurs,
                vision,
                // Conserver les sources existantes si modification
                sources: currentEdit.index === -1 ? [] : (data.projets[currentEdit.index].sources || []),
                lien_source: currentEdit.index === -1 ? [] : (data.projets[currentEdit.index].lien_source || [])
            };

            if (currentEdit.index === -1) {
                data.projets.push(projet);
            } else {
                data.projets[currentEdit.index] = projet;
            }
            
            markModified('projets');
            renderProjets();
            closeModal();
            showToast('‚úÖ Projet enregistr√©', 'success');
        }


        function deleteProjet(index) {
            if (confirm('Supprimer ce projet ?')) {
                data.projets.splice(index, 1);
                markModified('projets');
                renderProjets();
                showToast('üóëÔ∏è Projet supprim√©', 'success');
            }
        }

        // ===== ACTIONS =====
        let currentActionFilter = '';
        
        function filterActions(theme) {
            currentActionFilter = theme;
            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
            renderActions();
        }
        
        function updateThemeCounts() {
            // Compter les actions par th√®me
            const counts = {};
            THEMES_ACTIONS.forEach(t => counts[t.value] = 0);
            data.actions.forEach(a => {
                if (counts[a.theme] !== undefined) counts[a.theme]++;
            });
            
            // Mettre √† jour les compteurs
            document.getElementById('count-all').textContent = data.actions.length;
            THEMES_ACTIONS.forEach(t => {
                const el = document.getElementById('count-' + t.value);
                if (el) el.textContent = counts[t.value];
            });
        }
        
        // Configuration des th√®mes pour les actions (bilan)
        const THEMES_ACTIONS_CONFIG = {
            'Urbanisme': { icon: 'üèòÔ∏è', color: '#34495e' },
            'Sant√©': { icon: 'üè•', color: '#e91e63' },
            'Environnement': { icon: 'üåø', color: '#27ae60' },
            'Culture': { icon: 'üé≠', color: '#9b59b6' },
            'Patrimoine': { icon: 'üèõÔ∏è', color: '#8e44ad' },
            'Enfance': { icon: 'üë∂', color: '#3498db' },
            'Solidarit√©': { icon: 'ü§ù', color: '#e74c3c' },
            'Sport': { icon: '‚öΩ', color: '#2ecc71' },
            '√âconomie': { icon: 'üíº', color: '#f39c12' },
            'Mobilit√©s': { icon: 'üö¥', color: '#1abc9c' },
            'Tranquillit√©': { icon: 'üõ°Ô∏è', color: '#2c3e50' },
            'Finance': { icon: 'üí∞', color: '#795548' }
        };

        // Variable pour suivre le th√®me actuellement affich√© en d√©tail pour les actions
        let currentActionThemeDetail = null;

        function renderActions() {
            updateThemeCounts();

            const search = (document.getElementById('search-actions')?.value || '').toLowerCase();

            // Si recherche active ou filtre th√®me via boutons, afficher directement les cartes
            if (search || currentActionFilter) {
                showActionsCards(search);
                return;
            }

            // Si un th√®me est s√©lectionn√© en d√©tail, afficher ses actions
            if (currentActionThemeDetail) {
                showActionThemeDetail(currentActionThemeDetail);
                return;
            }

            // Sinon, afficher la vue par th√®mes
            showActionsThemesView();
        }

        function showActionsThemesView() {
            document.getElementById('actions-themes-view').style.display = 'grid';
            document.getElementById('actions-detail-view').style.display = 'none';

            // Grouper les actions par th√®me
            const themeGroups = {};
            data.actions.forEach(a => {
                const theme = a.theme || 'Non d√©fini';
                if (!themeGroups[theme]) {
                    themeGroups[theme] = [];
                }
                themeGroups[theme].push(a);
            });

            document.getElementById('actions-count').textContent = data.actions.length;

            // Trier les th√®mes par nombre d'actions
            const sortedThemes = Object.entries(themeGroups).sort((a, b) => b[1].length - a[1].length);

            document.getElementById('actions-themes-view').innerHTML = sortedThemes.length === 0
                ? '<div class="empty-state" style="grid-column: 1/-1;"><div class="icon">üì≠</div><p>Aucune action</p></div>'
                : sortedThemes.map(([themeName, actions]) => {
                    const themeConf = THEMES_ACTIONS_CONFIG[themeName] || { icon: 'üìã', color: '#1a3a5c' };
                    const realises = actions.filter(a => a.statut === 'R√©alis√©').length;
                    const encours = actions.filter(a => a.statut === 'En cours').length;

                    return `
                    <div class="theme-card" onclick="showActionThemeDetail('${themeName}')">
                        <div class="theme-card-header" style="background: ${themeConf.color}">
                            <span class="theme-card-icon">${themeConf.icon}</span>
                            <div class="theme-card-info">
                                <h3>${themeName}</h3>
                                <span class="count">${actions.length} action${actions.length > 1 ? 's' : ''}</span>
                            </div>
                        </div>
                        <div class="theme-card-stats">
                            <span>‚úÖ ${realises} r√©alis√©e(s)${encours > 0 ? ' ‚Ä¢ üîÑ ' + encours + ' en cours' : ''}</span>
                            <span class="theme-card-arrow">‚Üí</span>
                        </div>
                    </div>
                `}).join('');
        }

        function showActionThemeDetail(themeName) {
            currentActionThemeDetail = themeName;
            document.getElementById('actions-themes-view').style.display = 'none';
            document.getElementById('actions-detail-view').style.display = 'block';

            const themeConf = THEMES_ACTIONS_CONFIG[themeName] || { icon: 'üìã', color: '#1a3a5c' };

            // Filtrer les actions de ce th√®me
            const actions = data.actions.filter(a => a.theme === themeName);

            document.getElementById('actions-count').textContent = actions.length;

            document.getElementById('actions-detail-view').innerHTML = `
                <div class="theme-detail">
                    <div class="theme-detail-header">
                        <div class="theme-detail-title">
                            <span style="font-size: 1.5rem;">${themeConf.icon}</span>
                            <span>${themeName}</span>
                            <span style="color: #888; font-weight: normal; font-size: 1rem;">(${actions.length} action${actions.length > 1 ? 's' : ''})</span>
                        </div>
                        <button class="btn-back-theme" onclick="backToActionsThemes()">‚Üê Retour aux th√®mes</button>
                    </div>
                    <div class="cards-grid">
                        ${actions.map(a => renderActionCard(a)).join('')}
                    </div>
                </div>
            `;
        }

        function backToActionsThemes() {
            currentActionThemeDetail = null;
            currentActionFilter = '';
            document.querySelectorAll('#tab-actions .theme-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#tab-actions .theme-btn')?.classList.add('active');
            renderActions();
        }

        function showActionsCards(search) {
            document.getElementById('actions-themes-view').style.display = 'none';
            document.getElementById('actions-detail-view').style.display = 'block';

            let filtered = data.actions;

            // Filtre par th√®me
            if (currentActionFilter) {
                filtered = filtered.filter(a => a.theme === currentActionFilter);
            }

            // Filtre par recherche
            if (search) {
                filtered = filtered.filter(a =>
                    (a.titre || '').toLowerCase().includes(search) ||
                    (a.description || '').toLowerCase().includes(search)
                );
            }

            document.getElementById('actions-count').textContent = filtered.length;

            document.getElementById('actions-detail-view').innerHTML = `
                <div class="theme-detail">
                    <div class="theme-detail-header">
                        <div class="theme-detail-title">
                            <span>üîç R√©sultats</span>
                            <span style="color: #888; font-weight: normal; font-size: 1rem;">(${filtered.length} action${filtered.length > 1 ? 's' : ''})</span>
                        </div>
                        <button class="btn-back-theme" onclick="backToActionsThemes()">‚Üê Retour aux th√®mes</button>
                    </div>
                    <div class="cards-grid">
                        ${filtered.length === 0
                            ? '<div class="empty-state" style="grid-column: 1/-1;"><div class="icon">üì≠</div><p>Aucune action trouv√©e</p></div>'
                            : filtered.map(a => renderActionCard(a)).join('')}
                    </div>
                </div>
            `;
        }

        function renderActionCard(a) {
            const themeConf = THEMES_ACTIONS_CONFIG[a.theme] || { icon: 'üìã', color: '#1a3a5c' };
            const statut = a.statut || 'R√©alis√©';
            const statutClass = statut.toLowerCase().replace(/\s+/g, '-').replace('√©', 'e');

            return `
                <div class="admin-card">
                    <div class="admin-card-header">
                        <span class="admin-card-theme" style="background: ${themeConf.color}">
                            ${themeConf.icon} ${a.theme}
                        </span>
                        <span class="admin-card-statut statut-${statutClass}">${statut}</span>
                    </div>
                    <div class="admin-card-body">
                        <div class="admin-card-title">${a.titre}</div>
                        <div class="admin-card-desc">${a.description || ''}</div>
                        <div class="admin-card-footer">
                            <span class="admin-card-meta">${a.annee || ''}</span>
                            <div class="admin-card-actions">
                                <button class="btn btn-sm btn-primary" onclick="openEditAction(${data.actions.indexOf(a)})">‚úèÔ∏è Modifier</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAction(${data.actions.indexOf(a)})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function openAddAction() {
            currentEdit = { type: 'action', index: -1 };
            showActionModal({});
        }

        function openEditAction(index) {
            currentEdit = { type: 'action', index };
            showActionModal(data.actions[index]);
        }

        function showActionModal(a) {
            document.getElementById('modal-title').textContent = currentEdit.index === -1 ? '‚ûï Ajouter une action' : '‚úèÔ∏è Modifier l\'action';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label>Titre *</label>
                    <input type="text" id="edit-titre" value="${a.titre || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Th√®me *</label>
                        <select id="edit-theme">
                            <option value="">-- Choisir --</option>
                            ${THEMES_ACTIONS.map(t => `<option value="${t.value}" ${a.theme === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Statut</label>
                        <select id="edit-statut">
                            <option value="R√©alis√©" ${a.statut === 'R√©alis√©' ? 'selected' : ''}>‚úÖ R√©alis√©</option>
                            <option value="En cours" ${a.statut === 'En cours' ? 'selected' : ''}>üîÑ En cours</option>
                            <option value="Pr√©vu" ${a.statut === 'Pr√©vu' ? 'selected' : ''}>üìÖ Pr√©vu</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit-description" rows="3">${a.description || ''}</textarea>
                </div>
            `;
            document.getElementById('modal-save').onclick = saveAction;
            document.getElementById('modal-edit').classList.add('active');
        }

        function saveAction() {
            const titre = document.getElementById('edit-titre').value.trim();
            const theme = document.getElementById('edit-theme').value;
            const statut = document.getElementById('edit-statut').value;
            const description = document.getElementById('edit-description').value.trim();
            
            if (!titre || !theme) {
                showToast('‚ö†Ô∏è Titre et th√®me obligatoires', 'warning');
                return;
            }

            if (currentEdit.index === -1) {
                data.actions.push({ id: Date.now(), titre, theme, statut, description });
            } else {
                Object.assign(data.actions[currentEdit.index], { titre, theme, statut, description });
            }
            
            markModified('actions');
            renderActions();
            closeModal();
            showToast('‚úÖ Action enregistr√©e', 'success');
        }

        function deleteAction(index) {
            if (confirm('Supprimer cette action ?')) {
                data.actions.splice(index, 1);
                markModified('actions');
                renderActions();
                showToast('üóëÔ∏è Action supprim√©e', 'success');
            }
        }

        // ===== CANDIDATS =====
        function getPhotoUrl(photo) {
            if (!photo) return null;
            // Ignorer les chemins locaux
            if (photo.startsWith('file://')) return null;
            // Si c'est d√©j√† une URL compl√®te
            if (photo.startsWith('http')) return photo;
            // Si c'est un chemin relatif, construire l'URL GitHub
            return `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${photo}`;
        }

        function renderCandidats() {
            const search = (document.getElementById('search-candidats')?.value || '').toLowerCase();
            const sorted = [...data.candidats].sort((a, b) => (a.ordre || 99) - (b.ordre || 99));

            const filtered = sorted.filter(c => {
                if (!search) return true;
                return (c.nom || '').toLowerCase().includes(search) ||
                       (c.role || '').toLowerCase().includes(search) ||
                       (c.delegation || '').toLowerCase().includes(search) ||
                       (c.bio || '').toLowerCase().includes(search);
            });

            document.getElementById('candidats-count').textContent = filtered.length;

            document.getElementById('candidats-list').innerHTML = filtered.length === 0
                ? '<div class="empty-state"><div class="icon">üë•</div><p>Aucun candidat' + (search ? ' trouv√©' : '') + '</p></div>'
                : filtered.map((c, i) => {
                    const realIndex = data.candidats.indexOf(c);
                    const photoUrl = getPhotoUrl(c.photo);

                    let socialsHtml = '';
                    if (c.email || c.facebook || c.linkedin || c.twitter) {
                        socialsHtml = '<div class="candidat-card-socials">';
                        if (c.email) socialsHtml += `<span title="${c.email}">üìß</span>`;
                        if (c.facebook) socialsHtml += `<span title="Facebook">üìò</span>`;
                        if (c.linkedin) socialsHtml += `<span title="LinkedIn">üíº</span>`;
                        if (c.twitter) socialsHtml += `<span title="Twitter">üê¶</span>`;
                        socialsHtml += '</div>';
                    }

                    return `
                        <div class="candidat-card">
                            <div class="candidat-card-photo">
                                ${photoUrl
                                    ? `<img src="${photoUrl}" alt="${c.nom}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                       <span class="no-photo" style="display:none;">üë§</span>`
                                    : '<span class="no-photo">üë§</span>'}
                                <span class="candidat-card-ordre">${c.ordre || i + 1}</span>
                            </div>
                            <div class="candidat-card-body">
                                <div class="candidat-card-name">${c.nom || 'Sans nom'}</div>
                                ${c.role ? `<div class="candidat-card-role">${c.role}</div>` : ''}
                                ${c.delegation ? `<div class="candidat-card-delegation">${c.delegation}</div>` : ''}
                                ${c.bio ? `<div class="candidat-card-bio">${c.bio}</div>` : ''}
                                ${c.citation ? `<div class="candidat-card-citation">¬´ ${c.citation} ¬ª</div>` : ''}
                                ${socialsHtml}
                                <div class="candidat-card-footer">
                                    <button class="btn btn-sm btn-primary" onclick="openEditCandidat(${realIndex})">‚úèÔ∏è Modifier</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteCandidat(${realIndex})">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function openAddCandidat() {
            currentEdit = { type: 'candidat', index: -1 };
            pendingPhoto = null;
            showCandidatModal({});
        }

        function openEditCandidat(index) {
            currentEdit = { type: 'candidat', index };
            pendingPhoto = null;
            showCandidatModal(data.candidats[index]);
        }

        function showCandidatModal(c) {
            const photoUrl = getPhotoUrl(c.photo);
            document.getElementById('modal-title').textContent = currentEdit.index === -1 ? '‚ûï Ajouter un candidat' : '‚úèÔ∏è Modifier le candidat';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom complet *</label>
                        <input type="text" id="edit-nom" value="${c.nom || ''}">
                    </div>
                    <div class="form-group">
                        <label>Ordre d'affichage</label>
                        <input type="number" id="edit-ordre" value="${c.ordre || 10}" min="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>R√¥le / Fonction</label>
                        <input type="text" id="edit-role" value="${c.role || ''}" placeholder="Ex: Adjoint aux finances">
                    </div>
                    <div class="form-group">
                        <label>D√©l√©gation / Domaine</label>
                        <input type="text" id="edit-delegation" value="${c.delegation || ''}" placeholder="Ex: Urbanisme, Environnement">
                    </div>
                </div>
                <div class="form-group">
                    <label>Biographie</label>
                    <textarea id="edit-bio" rows="3" placeholder="Courte pr√©sentation...">${c.bio || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>üéì Parcours</label>
                    <textarea id="edit-pedigree" rows="3" placeholder="Formation, exp√©riences professionnelles, engagements pass√©s...">${c.pedigree || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>üéØ Objectifs de campagne</label>
                    <textarea id="edit-objectifs" rows="3" placeholder="Mes priorit√©s pour Vizille...">${c.objectifs || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>üí¨ Citation / Engagement personnel</label>
                    <input type="text" id="edit-citation" value="${c.citation || ''}" placeholder="Ex: Mon engagement pour Vizille...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>üìß Email (optionnel)</label>
                        <input type="email" id="edit-email" value="${c.email || ''}" placeholder="prenom.nom@email.com">
                    </div>
                    <div class="form-group">
                        <label>üìò Facebook (URL)</label>
                        <input type="url" id="edit-facebook" value="${c.facebook || ''}" placeholder="https://facebook.com/...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>üíº LinkedIn (URL)</label>
                        <input type="url" id="edit-linkedin" value="${c.linkedin || ''}" placeholder="https://linkedin.com/in/...">
                    </div>
                    <div class="form-group">
                        <label>üê¶ Twitter (URL)</label>
                        <input type="url" id="edit-twitter" value="${c.twitter || ''}" placeholder="https://twitter.com/...">
                    </div>
                </div>
                <div class="form-group">
                    <label>Photo</label>
                    <div class="photo-upload" onclick="document.getElementById('photo-input').click()" 
                         ondragover="event.preventDefault(); this.classList.add('dragover')"
                         ondragleave="this.classList.remove('dragover')"
                         ondrop="handlePhotoDrop(event)">
                        <input type="file" id="photo-input" accept="image/*" onchange="handlePhotoSelect(event)">
                        <div class="icon">üì∑</div>
                        <p>Cliquez ou glissez une photo</p>
                        <p style="font-size: 0.8rem; opacity: 0.7;">Max 1 Mo ‚Ä¢ JPG, PNG</p>
                    </div>
                    <div class="photo-preview ${photoUrl ? 'active' : ''}" id="photo-preview">
                        <img src="${photoUrl || ''}" id="photo-preview-img" onerror="this.parentElement.classList.remove('active');">
                        <button class="btn btn-sm btn-danger" style="margin-top: 0.5rem;" onclick="removePhoto()">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-save').onclick = saveCandidat;
            document.getElementById('modal-edit').classList.add('active');
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (file) processPhoto(file);
        }

        function handlePhotoDrop(event) {
            event.preventDefault();
            event.target.classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file) processPhoto(file);
        }

        function processPhoto(file) {
            if (file.size > 1024 * 1024) {
                showToast('‚ö†Ô∏è Image trop grande (max 1 Mo)', 'warning');
                return;
            }

            if (!file.type.startsWith('image/')) {
                showToast('‚ö†Ô∏è Fichier non valide', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                pendingPhoto = {
                    data: e.target.result,
                    name: file.name,
                    type: file.type
                };
                
                document.getElementById('photo-preview-img').src = e.target.result;
                document.getElementById('photo-preview').classList.add('active');
                showToast('‚úÖ Photo pr√™te', 'success');
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            pendingPhoto = { remove: true };
            document.getElementById('photo-preview').classList.remove('active');
            document.getElementById('photo-preview-img').src = '';
        }

        async function saveCandidat() {
            const nom = document.getElementById('edit-nom').value.trim();
            const role = document.getElementById('edit-role').value.trim();
            const delegation = document.getElementById('edit-delegation').value.trim();
            const bio = document.getElementById('edit-bio').value.trim();
            const pedigree = document.getElementById('edit-pedigree').value.trim();
            const objectifs = document.getElementById('edit-objectifs').value.trim();
            const citation = document.getElementById('edit-citation').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const facebook = document.getElementById('edit-facebook').value.trim();
            const linkedin = document.getElementById('edit-linkedin').value.trim();
            const twitter = document.getElementById('edit-twitter').value.trim();
            const ordre = parseInt(document.getElementById('edit-ordre').value) || 10;
            
            if (!nom) {
                showToast('‚ö†Ô∏è Nom obligatoire', 'warning');
                return;
            }

            let photo = currentEdit.index >= 0 ? data.candidats[currentEdit.index].photo : null;

            // Upload photo si nouvelle
            if (pendingPhoto && !pendingPhoto.remove) {
                showToast('‚è≥ Upload de la photo...', 'info');
                const photoUrl = await uploadPhoto(pendingPhoto, nom);
                if (photoUrl) {
                    photo = photoUrl;
                }
            } else if (pendingPhoto && pendingPhoto.remove) {
                photo = null;
            }

            const candidatData = { 
                id: currentEdit.index >= 0 ? data.candidats[currentEdit.index].id : Date.now(),
                nom, role, delegation, bio, pedigree, objectifs, citation, email, facebook, linkedin, twitter, ordre, photo, actif: true 
            };

            if (currentEdit.index === -1) {
                data.candidats.push(candidatData);
            } else {
                data.candidats[currentEdit.index] = candidatData;
            }
            
            markModified('candidats');
            renderCandidats();
            closeModal();
            showToast('‚úÖ Candidat enregistr√©', 'success');
        }

        async function uploadPhoto(photoData, nom, retryCount = 0) {
            const token = getToken();
            if (!token) {
                showToast('‚ö†Ô∏è Token requis pour l\'upload', 'warning');
                return null;
            }

            // Nom de fichier propre
            const ext = photoData.name.split('.').pop().toLowerCase();
            const cleanName = nom.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Enlever accents
                .replace(/[^a-z0-9]/g, '-')
                .replace(/-+/g, '-');
            const filename = `images/${cleanName}.${ext}`;
            
            // Extraire le base64 pur (sans le pr√©fixe data:image/...)
            const base64Content = photoData.data.split(',')[1];

            try {
                // R√©cup√©rer le SHA si le fichier existe
                let sha = null;
                const getResponse = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}?ref=${GITHUB_CONFIG.branch}`,
                    { headers: { 'Authorization': `token ${token}` } }
                );
                if (getResponse.ok) {
                    sha = (await getResponse.json()).sha;
                }

                const body = {
                    message: `Upload photo ${nom}`,
                    content: base64Content,
                    branch: GITHUB_CONFIG.branch
                };
                if (sha) body.sha = sha;

                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    }
                );

                if (response.ok) {
                    showToast('‚úÖ Photo upload√©e', 'success');
                    return filename;
                } else if (response.status === 409 && retryCount < 3) {
                    // Conflit - r√©essayer
                    showToast('üîÑ Conflit, nouvelle tentative...', 'warning');
                    await new Promise(r => setTimeout(r, 1000));
                    return uploadPhoto(photoData, nom, retryCount + 1);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Upload failed');
                }
            } catch (err) {
                showToast('‚ùå Erreur upload: ' + err.message, 'error');
                return null;
            }
        }

        function deleteCandidat(index) {
            if (confirm('Supprimer ce candidat ?')) {
                data.candidats.splice(index, 1);
                markModified('candidats');
                renderCandidats();
                showToast('üóëÔ∏è Candidat supprim√©', 'success');
            }
        }

        // ===== FAQ =====
        function renderFaq() {
            document.getElementById('faq-count').textContent = data.faq.length;
            document.getElementById('faq-list').innerHTML = data.faq.length === 0
                ? '<div class="empty-state"><div class="icon">‚ùì</div><p>Aucune question</p></div>'
                : data.faq.map((f, i) => {
                    const origineIcons = {
                        'Site web': 'üåê',
                        'Facebook': 'üìò',
                        'WhatsApp': 'üí¨',
                        'Permanence': 'üèõÔ∏è',
                        'Email': 'üìß',
                        'Autre': 'üìù'
                    };
                    const origineIcon = origineIcons[f.origine] || '‚ùì';
                    return `
                    <div class="item-card">
                        <div class="item-info">
                            <div class="item-text">
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.25rem;">
                                    ${f.categorie ? `<span class="item-badge">${f.categorie}</span>` : ''}
                                    ${f.origine ? `<span class="item-badge" style="background: #e8f4fc; color: var(--bleu);">${origineIcon} ${f.origine}</span>` : ''}
                                    ${f.pseudo ? `<span class="item-badge" style="background: #f0f0f0; color: #666;">üë§ ${f.pseudo}</span>` : ''}
                                </div>
                                <div class="item-title">${f.question}</div>
                                <div class="item-desc">${(f.reponse || '').substring(0, 100)}...</div>
                                ${f.date ? `<div class="item-desc" style="font-size: 0.8rem; opacity: 0.6;">üìÖ ${f.date}</div>` : ''}
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm" style="background: #25D366; color: white;" onclick="copyForWhatsApp('faq', ${i})" title="Copier pour WhatsApp">üí¨</button>
                            <button class="btn btn-sm btn-primary" onclick="openEditFaq(${i})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFaq(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                `}).join('');
        }
        
        function copyForWhatsApp(type, index) {
            let text = '';
            
            if (type === 'faq') {
                const f = data.faq[index];
                text = `‚ùì *QUESTION D'UN VIZILLOIS*\n\n`;
                if (f.pseudo) text += `üë§ _${f.pseudo}_\n`;
                if (f.categorie) text += `üè∑Ô∏è ${f.categorie}\n`;
                text += `\nüìù *${f.question}*\n\n`;
                text += `‚úÖ *Notre r√©ponse :*\n${f.reponse}\n\n`;
                text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                text += `üó≥Ô∏è *Vizille en Mouvement*\n`;
                text += `üåê https://Vizilleenmouvement.github.io/Vizille-en-mouvement/`;
            } 
            else if (type === 'article') {
                const a = data.articles[index];
                text = `üì∞ *${a.titre}*\n\n`;
                if (a.date) text += `üìÖ ${a.date}\n\n`;
                text += `${a.resume || a.contenu?.substring(0, 200) || ''}\n\n`;
                text += `üëâ Lire la suite sur notre site\n`;
                text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                text += `üó≥Ô∏è *Vizille en Mouvement*\n`;
                text += `üåê https://Vizilleenmouvement.github.io/Vizille-en-mouvement/blog.html`;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('‚úÖ Copi√© ! Collez dans WhatsApp', 'success');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('‚úÖ Copi√© ! Collez dans WhatsApp', 'success');
            });
        }

        function openAddFaq() {
            currentEdit = { type: 'faq', index: -1 };
            showFaqModal({});
        }

        function openEditFaq(index) {
            currentEdit = { type: 'faq', index };
            showFaqModal(data.faq[index]);
        }

        function showFaqModal(f) {
            document.getElementById('modal-title').textContent = currentEdit.index === -1 ? '‚ûï Ajouter une question' : '‚úèÔ∏è Modifier la question';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>üìç Origine *</label>
                        <select id="edit-origine">
                            <option value="">-- Source --</option>
                            <option value="Site web" ${f.origine === 'Site web' ? 'selected' : ''}>üåê Site web</option>
                            <option value="Facebook" ${f.origine === 'Facebook' ? 'selected' : ''}>üìò Facebook</option>
                            <option value="WhatsApp" ${f.origine === 'WhatsApp' ? 'selected' : ''}>üí¨ WhatsApp</option>
                            <option value="Permanence" ${f.origine === 'Permanence' ? 'selected' : ''}>üèõÔ∏è Permanence</option>
                            <option value="Email" ${f.origine === 'Email' ? 'selected' : ''}>üìß Email</option>
                            <option value="Autre" ${f.origine === 'Autre' ? 'selected' : ''}>üìù Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üë§ Pseudo / Nom</label>
                        <input type="text" id="edit-pseudo" value="${f.pseudo || ''}" placeholder="Ex: Marie D., Anonyme...">
                    </div>
                    <div class="form-group">
                        <label>üìÖ Date</label>
                        <input type="date" id="edit-date" value="${f.date || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Question *</label>
                    <input type="text" id="edit-question" value="${f.question || ''}">
                </div>
                <div class="form-group">
                    <label>R√©ponse *</label>
                    <textarea id="edit-reponse" rows="5">${f.reponse || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Cat√©gorie / Th√®me</label>
                    <input type="text" id="edit-categorie" value="${f.categorie || ''}" placeholder="Ex: Urbanisme, Tranquillit√©, Vie municipale...">
                </div>
            `;
            document.getElementById('modal-save').onclick = saveFaq;
            document.getElementById('modal-edit').classList.add('active');
        }

        function saveFaq() {
            const question = document.getElementById('edit-question').value.trim();
            const reponse = document.getElementById('edit-reponse').value.trim();
            const categorie = document.getElementById('edit-categorie').value.trim();
            const origine = document.getElementById('edit-origine').value;
            const pseudo = document.getElementById('edit-pseudo').value.trim();
            const date = document.getElementById('edit-date').value;
            
            if (!question || !reponse) {
                showToast('‚ö†Ô∏è Question et r√©ponse obligatoires', 'warning');
                return;
            }

            if (currentEdit.index === -1) {
                data.faq.push({ id: Date.now(), question, reponse, categorie, origine, pseudo, date });
            } else {
                Object.assign(data.faq[currentEdit.index], { question, reponse, categorie, origine, pseudo, date });
            }
            
            markModified('faq');
            renderFaq();
            closeModal();
            showToast('‚úÖ Question enregistr√©e', 'success');
        }

        function deleteFaq(index) {
            if (confirm('Supprimer cette question ?')) {
                data.faq.splice(index, 1);
                markModified('faq');
                renderFaq();
                showToast('üóëÔ∏è Question supprim√©e', 'success');
            }
        }

        // ===== ARTICLES =====
        let currentArticleFilter = '';

        function filterArticles(category) {
            currentArticleFilter = category;
            // Mise √† jour des boutons de filtre
            document.querySelectorAll('#article-category-filters .theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
            renderArticles();
        }

        function updateArticleCategoryCounts() {
            const counts = { all: data.articles.length };
            const categories = ['√âv√©nement', 'Communiqu√©', 'R√©union', 'Action', 'Bilan', 'Projet', 'Tribune', 'Info'];
            categories.forEach(cat => {
                counts[cat] = data.articles.filter(a => a.categorie === cat).length;
            });

            const el = (id) => document.getElementById(id);
            if (el('acount-all')) el('acount-all').textContent = counts.all;
            if (el('acount-evenement')) el('acount-evenement').textContent = counts['√âv√©nement'] || 0;
            if (el('acount-communique')) el('acount-communique').textContent = counts['Communiqu√©'] || 0;
            if (el('acount-reunion')) el('acount-reunion').textContent = counts['R√©union'] || 0;
            if (el('acount-action')) el('acount-action').textContent = counts['Action'] || 0;
            if (el('acount-bilan')) el('acount-bilan').textContent = counts['Bilan'] || 0;
            if (el('acount-projet')) el('acount-projet').textContent = counts['Projet'] || 0;
            if (el('acount-tribune')) el('acount-tribune').textContent = counts['Tribune'] || 0;
            if (el('acount-info')) el('acount-info').textContent = counts['Info'] || 0;
        }

        function getCategoryClass(categorie) {
            if (!categorie) return '';
            const map = {
                '√âv√©nement': 'evenement',
                'Communiqu√©': 'communique',
                'R√©union': 'reunion',
                'Action': 'action',
                'Bilan': 'bilan',
                'Projet': 'projet',
                'Tribune': 'tribune',
                'Info': 'info'
            };
            return map[categorie] || '';
        }

        function getCategoryIcon(categorie) {
            const icons = {
                '√âv√©nement': 'üìÖ',
                'Communiqu√©': 'üì£',
                'R√©union': 'ü§ù',
                'Action': '‚úä',
                'Bilan': 'üìä',
                'Projet': 'üöÄ',
                'Tribune': 'üìù',
                'Info': '‚ÑπÔ∏è'
            };
            return icons[categorie] || 'üì∞';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Sans date';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function renderArticles() {
            updateArticleCategoryCounts();

            const search = (document.getElementById('search-articles')?.value || '').toLowerCase();
            let filtered = [...data.articles].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

            // Filtre par cat√©gorie
            if (currentArticleFilter) {
                filtered = filtered.filter(a => a.categorie === currentArticleFilter);
            }

            // Filtre par recherche
            if (search) {
                filtered = filtered.filter(a =>
                    (a.titre || '').toLowerCase().includes(search) ||
                    (a.extrait || '').toLowerCase().includes(search) ||
                    (a.contenu || '').toLowerCase().includes(search) ||
                    (a.categorie || '').toLowerCase().includes(search)
                );
            }

            document.getElementById('articles-count').textContent = filtered.length;

            document.getElementById('articles-list').innerHTML = filtered.length === 0
                ? '<div class="empty-state"><div class="icon">üì∞</div><p>Aucun article' + (search || currentArticleFilter ? ' trouv√©' : '') + '</p></div>'
                : filtered.map((a, i) => {
                    const realIndex = data.articles.indexOf(a);
                    const categoryClass = getCategoryClass(a.categorie);
                    const categoryIcon = getCategoryIcon(a.categorie);

                    return `
                        <div class="article-card">
                            <div class="article-card-image">
                                ${a.image
                                    ? `<img src="${a.image}" alt="${a.titre}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                       <span class="no-image" style="display:none;">üì∞</span>`
                                    : '<span class="no-image">üì∞</span>'}
                                ${a.categorie ? `<span class="article-card-category ${categoryClass}">${categoryIcon} ${a.categorie}</span>` : ''}
                            </div>
                            <div class="article-card-body">
                                <div class="article-card-date">üìÖ ${formatDate(a.date)}</div>
                                <div class="article-card-title">${a.titre || 'Sans titre'}</div>
                                <div class="article-card-extrait">${a.extrait || a.contenu?.substring(0, 150) || 'Aucun extrait'}</div>
                                <div class="article-card-footer">
                                    <div class="article-card-share">
                                        <button class="btn btn-sm" style="background: #25D366; color: white;" onclick="copyForWhatsApp('article', ${realIndex})" title="WhatsApp">üí¨</button>
                                        <button class="btn btn-sm" style="background: #1877f2; color: white;" onclick="copyForFacebook(${realIndex})" title="Facebook">üìò</button>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-sm btn-primary" onclick="openEditArticle(${realIndex})">‚úèÔ∏è</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteArticle(${realIndex})">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            // Mettre √† jour la liste pour le partage Facebook
            updateFacebookArticleSelect();
        }

        function copyForFacebook(index) {
            const a = data.articles[index];
            const text = `üì∞ ${a.titre}\n\n${a.extrait || a.contenu?.substring(0, 200) || ''}\n\nüëâ Lire la suite sur notre site\n\n#Vizille #Municipales2026 #VizilleEnMouvement`;
            navigator.clipboard.writeText(text).then(() => {
                showToast('üìã Texte copi√© pour Facebook !', 'success');
            });
        }

        function openAddArticle() {
            currentEdit = { type: 'article', index: -1 };
            showArticleModal({ date: new Date().toISOString().split('T')[0] });
        }

        function openEditArticle(index) {
            currentEdit = { type: 'article', index };
            showArticleModal(data.articles[index]);
        }

        function showArticleModal(a) {
            document.getElementById('modal-title').textContent = currentEdit.index === -1 ? '‚ûï Ajouter un article' : '‚úèÔ∏è Modifier l\'article';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Titre *</label>
                        <input type="text" id="edit-titre" value="${a.titre || ''}">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="edit-date" value="${a.date || ''}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cat√©gorie</label>
                        <select id="edit-categorie">
                            <option value="">-- Sans cat√©gorie --</option>
                            <option value="√âv√©nement" ${a.categorie === '√âv√©nement' ? 'selected' : ''}>üìÖ √âv√©nement</option>
                            <option value="Communiqu√©" ${a.categorie === 'Communiqu√©' ? 'selected' : ''}>üì£ Communiqu√©</option>
                            <option value="R√©union" ${a.categorie === 'R√©union' ? 'selected' : ''}>ü§ù R√©union</option>
                            <option value="Action" ${a.categorie === 'Action' ? 'selected' : ''}>‚úä Action</option>
                            <option value="Bilan" ${a.categorie === 'Bilan' ? 'selected' : ''}>üìä Bilan</option>
                            <option value="Projet" ${a.categorie === 'Projet' ? 'selected' : ''}>üöÄ Projet</option>
                            <option value="Tribune" ${a.categorie === 'Tribune' ? 'selected' : ''}>üìù Tribune</option>
                            <option value="Info" ${a.categorie === 'Info' ? 'selected' : ''}>‚ÑπÔ∏è Info</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Image (URL)</label>
                        <input type="url" id="edit-image" value="${a.image || ''}" placeholder="https://... ou images/nom.jpg">
                    </div>
                </div>
                <div class="form-group">
                    <label>Extrait (aper√ßu court)</label>
                    <textarea id="edit-extrait" rows="2" placeholder="Court r√©sum√© affich√© dans la liste des actualit√©s...">${a.extrait || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Contenu complet</label>
                    <textarea id="edit-contenu" rows="8" placeholder="Le texte complet de l'article. Utilisez des sauts de ligne pour s√©parer les paragraphes.">${a.contenu || ''}</textarea>
                </div>
                <div id="image-preview" style="margin-top: 1rem; display: ${a.image ? 'block' : 'none'};">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--bleu);">Aper√ßu image :</label>
                    <img src="${a.image || ''}" alt="Aper√ßu" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid var(--gris-border);" onerror="this.parentElement.style.display='none'">
                </div>
            `;
            
            // Pr√©visualiser l'image quand l'URL change
            document.getElementById('edit-image').addEventListener('input', function() {
                const preview = document.getElementById('image-preview');
                const img = preview.querySelector('img');
                if (this.value) {
                    img.src = this.value;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            });
            
            document.getElementById('modal-save').onclick = saveArticle;
            document.getElementById('modal-edit').classList.add('active');
        }

        function saveArticle() {
            const titre = document.getElementById('edit-titre').value.trim();
            const date = document.getElementById('edit-date').value;
            const categorie = document.getElementById('edit-categorie').value;
            const image = document.getElementById('edit-image').value.trim();
            const extrait = document.getElementById('edit-extrait').value.trim();
            const contenu = document.getElementById('edit-contenu').value.trim();
            
            if (!titre) {
                showToast('‚ö†Ô∏è Titre obligatoire', 'warning');
                return;
            }

            const articleData = { 
                id: currentEdit.index === -1 ? Date.now() : data.articles[currentEdit.index].id,
                titre, 
                date, 
                categorie,
                image,
                extrait, 
                contenu 
            };

            if (currentEdit.index === -1) {
                data.articles.push(articleData);
            } else {
                data.articles[currentEdit.index] = articleData;
            }
            
            markModified('articles');
            renderArticles();
            updateFacebookArticleSelect();
            closeModal();
            showToast('‚úÖ Article enregistr√©', 'success');
        }

        function deleteArticle(index) {
            if (confirm('Supprimer cet article ?')) {
                data.articles.splice(index, 1);
                markModified('articles');
                renderArticles();
                showToast('üóëÔ∏è Article supprim√©', 'success');
            }
        }

        // ===== ABONN√âS NEWSLETTER =====
        function renderAbonnes() {
            const search = (document.getElementById('search-abonnes')?.value || '').toLowerCase();
            const abonnesActifs = data.abonnes.filter(a => a.actif !== false);
            
            const filtered = data.abonnes.filter(a => {
                if (!search) return true;
                return (a.email || '').toLowerCase().includes(search) || 
                       (a.nom || '').toLowerCase().includes(search);
            });
            
            document.getElementById('abonnes-count').textContent = filtered.length;
            document.getElementById('stats-abonnes').textContent = `${abonnesActifs.length} abonn√©s actifs`;
            
            const container = document.getElementById('abonnes-list');
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìß</div>
                        <p>Aucun abonn√©${search ? ' trouv√©' : ''}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map((a, i) => {
                const realIndex = data.abonnes.indexOf(a);
                const statusClass = a.actif === false ? 'style="opacity: 0.5;"' : '';
                const statusBadge = a.actif === false ? 
                    '<span style="background: #fee; color: #c00; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">D√©sabonn√©</span>' : '';
                return `
                    <div class="item-card" ${statusClass}>
                        <div class="item-info">
                            <div class="item-photo-placeholder">üìß</div>
                            <div class="item-text">
                                <div class="item-title">${a.email}${statusBadge}</div>
                                <div class="item-desc">${a.nom || 'Sans nom'} ‚Ä¢ Inscrit le ${a.date || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-primary" onclick="openEditAbonne(${realIndex})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAbonne(${realIndex})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAddAbonne() {
            currentEdit = { type: 'abonne', index: -1 };
            showAbonneModal({ date: new Date().toISOString().split('T')[0], actif: true });
        }

        function openEditAbonne(index) {
            currentEdit = { type: 'abonne', index };
            showAbonneModal(data.abonnes[index]);
        }

        function showAbonneModal(a) {
            document.getElementById('modal-title').textContent = currentEdit.index === -1 ? '‚ûï Ajouter un abonn√©' : '‚úèÔ∏è Modifier l\'abonn√©';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="edit-abonne-email" value="${a.email || ''}">
                </div>
                <div class="form-group">
                    <label>Nom (optionnel)</label>
                    <input type="text" id="edit-abonne-nom" value="${a.nom || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date d'inscription</label>
                        <input type="date" id="edit-abonne-date" value="${a.date || ''}">
                    </div>
                    <div class="form-group">
                        <label>Statut</label>
                        <select id="edit-abonne-actif">
                            <option value="true" ${a.actif !== false ? 'selected' : ''}>‚úÖ Actif</option>
                            <option value="false" ${a.actif === false ? 'selected' : ''}>‚ùå D√©sabonn√©</option>
                        </select>
                    </div>
                </div>
            `;
            document.getElementById('modal-save').onclick = saveAbonne;
            document.getElementById('modal-edit').classList.add('active');
        }

        function saveAbonne() {
            const email = document.getElementById('edit-abonne-email').value.trim();
            const nom = document.getElementById('edit-abonne-nom').value.trim();
            const date = document.getElementById('edit-abonne-date').value;
            const actif = document.getElementById('edit-abonne-actif').value === 'true';
            
            if (!email || !email.includes('@')) {
                showToast('‚ö†Ô∏è Email invalide', 'warning');
                return;
            }

            // V√©rifier si l'email existe d√©j√† (sauf en √©dition du m√™me)
            const existant = data.abonnes.findIndex(a => a.email.toLowerCase() === email.toLowerCase());
            if (existant !== -1 && existant !== currentEdit.index) {
                showToast('‚ö†Ô∏è Cet email existe d√©j√†', 'warning');
                return;
            }

            if (currentEdit.index === -1) {
                data.abonnes.push({ id: Date.now(), email, nom, date, actif });
            } else {
                Object.assign(data.abonnes[currentEdit.index], { email, nom, date, actif });
            }
            
            markModified('abonnes');
            renderAbonnes();
            closeModal();
            showToast('‚úÖ Abonn√© enregistr√©', 'success');
        }

        function deleteAbonne(index) {
            if (confirm('Supprimer cet abonn√© ?')) {
                data.abonnes.splice(index, 1);
                markModified('abonnes');
                renderAbonnes();
                showToast('üóëÔ∏è Abonn√© supprim√©', 'success');
            }
        }

        function exportAbonnes() {
            const actifs = data.abonnes.filter(a => a.actif !== false);
            const csv = 'Email,Nom,Date\n' + actifs.map(a => `${a.email},"${a.nom || ''}",${a.date || ''}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `abonnes-vizille-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('üì• Export CSV t√©l√©charg√©', 'success');
        }

        function importAbonnes(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(l => l.trim());
                let count = 0;
                
                lines.forEach((line, i) => {
                    if (i === 0 && line.toLowerCase().includes('email')) return; // Skip header
                    
                    const parts = line.split(',');
                    const email = parts[0]?.trim().replace(/"/g, '');
                    
                    if (email && email.includes('@')) {
                        const existe = data.abonnes.find(a => a.email.toLowerCase() === email.toLowerCase());
                        if (!existe) {
                            data.abonnes.push({
                                id: Date.now() + count,
                                email,
                                nom: parts[1]?.trim().replace(/"/g, '') || '',
                                date: new Date().toISOString().split('T')[0],
                                actif: true
                            });
                            count++;
                        }
                    }
                });
                
                if (count > 0) {
                    markModified('abonnes');
                    renderAbonnes();
                    showToast(`‚úÖ ${count} abonn√©s import√©s`, 'success');
                } else {
                    showToast('‚ö†Ô∏è Aucun nouvel email trouv√©', 'warning');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ===== PARTAGE FACEBOOK =====
        function updateFacebookArticleSelect() {
            renderFacebookSelect();
        }
        
        function renderFacebookSelect() {
            const select = document.getElementById('fb-article-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- S√©lectionnez un article --</option>' +
                data.articles.map((a, i) => `<option value="${i}">${a.date || 'Sans date'} - ${a.titre}</option>`).join('');
        }

        function previewFacebookPost() {
            const select = document.getElementById('fb-article-select');
            const index = select.value;
            const previewZone = document.getElementById('fb-preview-zone');
            
            if (index === '') {
                previewZone.style.display = 'none';
                return;
            }
            
            const article = data.articles[index];
            const siteUrl = `https://Vizilleenmouvement.github.io/Vizille-en-mouvement/blog.html`;
            
            const postText = `üì∞ ${article.titre}

${article.extrait || article.resume || article.contenu?.substring(0, 200) + '...' || ''}

üëâ Lire l'article complet sur notre site :
${siteUrl}

#Vizille #Municipales2026 #VizilleEnMouvement`;
            
            document.getElementById('fb-post-text').value = postText;
            previewZone.style.display = 'block';
        }

        function copyFacebookPost() {
            const text = document.getElementById('fb-post-text').value;
            navigator.clipboard.writeText(text).then(() => {
                showToast('üìã Texte copi√© ! Collez-le sur Facebook', 'success');
            }).catch(() => {
                showToast('‚ùå Erreur de copie', 'error');
            });
        }

        // ===== NEWSLETTER =====
        function initNewsletterDate() {
            const dateInput = document.getElementById('nl-date');
            if (dateInput && !dateInput.value) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
        }

        function generateNewsletter() {
            const objet = document.getElementById('nl-objet').value.trim();
            const date = document.getElementById('nl-date').value;
            const intro = document.getElementById('nl-intro').value.trim();
            const contenu = document.getElementById('nl-contenu').value.trim();
            const cta = document.getElementById('nl-cta').value.trim();
            
            if (!objet || !contenu) {
                showToast('‚ö†Ô∏è Objet et contenu requis', 'warning');
                return;
            }
            
            const dateFormatted = date ? new Date(date).toLocaleDateString('fr-FR', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            }) : '';
            
            let newsletter = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üèõÔ∏è VIZILLE EN MOUVEMENT
Vos questions pour une ville dynamique et solidaire
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÖ ${dateFormatted}

`;
            
            if (intro) {
                newsletter += `${intro}\n\n`;
            }
            
            newsletter += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì∞ ACTUALIT√âS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${contenu}

`;
            
            if (cta) {
                newsletter += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì¢ √Ä NE PAS MANQUER
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${cta}

`;
            }
            
            newsletter += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì± SUIVEZ-NOUS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üåê Site : https://Vizilleenmouvement.github.io/Vizille-en-mouvement/
üìò Facebook : ${data.config.facebook || 'https://facebook.com/Vizilleenmouvement'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Pour vous d√©sabonner, r√©pondez √† cet email.
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
            
            document.getElementById('nl-output').value = newsletter;
            document.getElementById('nl-result').style.display = 'block';
            showToast('‚ú® Newsletter g√©n√©r√©e !', 'success');
        }

        function clearNewsletter() {
            document.getElementById('nl-objet').value = '';
            document.getElementById('nl-intro').value = '';
            document.getElementById('nl-contenu').value = '';
            document.getElementById('nl-cta').value = '';
            document.getElementById('nl-output').value = '';
            document.getElementById('nl-result').style.display = 'none';
            showToast('üóëÔ∏è Formulaire effac√©', 'info');
        }

        function copyNewsletter() {
            const text = document.getElementById('nl-output').value;
            navigator.clipboard.writeText(text).then(() => {
                showToast('üìã Newsletter copi√©e !', 'success');
            }).catch(() => {
                showToast('‚ùå Erreur de copie', 'error');
            });
        }

        function copyAbonnesEmails() {
            const actifs = data.abonnes.filter(a => a.actif !== false);
            const emails = actifs.map(a => a.email).join('; ');
            
            if (!emails) {
                showToast('‚ö†Ô∏è Aucun abonn√© actif', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(emails).then(() => {
                showToast(`üìß ${actifs.length} emails copi√©s !`, 'success');
            }).catch(() => {
                showToast('‚ùå Erreur de copie', 'error');
            });
        }

        // ===== CONFIG =====
        function renderConfig() {
            document.getElementById('config-email').value = data.config.email || '';
            document.getElementById('config-telephone').value = data.config.telephone || '';
            document.getElementById('config-adresse').value = data.config.adresse || '';
            document.getElementById('config-facebook').value = data.config.facebook || '';
            document.getElementById('config-instagram').value = data.config.instagram || '';
            document.getElementById('config-twitter').value = data.config.twitter || '';
            document.getElementById('config-autre').value = data.config.autre || '';
            document.getElementById('config-permanences').value = data.config.permanences || '';
            document.getElementById('config-slogan').value = data.config.slogan || 'Vos questions pour une ville dynamique et solidaire';
        }

        // ===== PUBLICATION =====
        // Flag pour √©viter les publications multiples simultan√©es
        const publishingInProgress = {};
        
        async function publish(section, retryCount = 0) {
            // √âviter les clics multiples
            if (publishingInProgress[section]) {
                showToast('‚è≥ Publication d√©j√† en cours...', 'info');
                return;
            }
            
            const token = getToken();
            if (!token) {
                showToast('‚ö†Ô∏è Configurez votre token GitHub', 'warning');
                return;
            }

            const files = {
                projets: 'projets.json',
                themes: 'themes.json',
                actions: 'data.json',
                candidats: 'candidats.json',
                faq: 'faq.json',
                articles: 'articles.json',
                abonnes: 'abonnes.json',
                config: 'config.json'
            };

            const filename = files[section];
            publishingInProgress[section] = true;
            
            // Pour themes, synchroniser avec THEMES_CONFIG
            if (section === 'themes') {
                data.themes = [...THEMES_CONFIG];
            }
            
            // Pour config, on doit d'abord lire les valeurs des champs
            if (section === 'config') {
                data.config = {
                    email: document.getElementById('config-email').value,
                    telephone: document.getElementById('config-telephone').value,
                    adresse: document.getElementById('config-adresse').value,
                    facebook: document.getElementById('config-facebook').value,
                    instagram: document.getElementById('config-instagram').value,
                    twitter: document.getElementById('config-twitter').value,
                    autre: document.getElementById('config-autre').value,
                    permanences: document.getElementById('config-permanences').value,
                    slogan: document.getElementById('config-slogan').value
                };
            }
            
            // Pour candidats, nettoyer les chemins de photos locaux
            if (section === 'candidats') {
                data.candidats = data.candidats.map(c => ({
                    ...c,
                    photo: c.photo && c.photo.startsWith('file://') ? '' : c.photo
                }));
            }
            
            const content = JSON.stringify(data[section], null, 2);

            setStatus(section, 'loading', '‚è≥ Publication...');

            try {
                // R√©cup√©rer le SHA actuel (avec cache-buster pour √©viter le cache)
                let sha = null;
                const timestamp = Date.now();
                const getResponse = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}?ref=${GITHUB_CONFIG.branch}&_=${timestamp}`,
                    { 
                        headers: { 
                            'Authorization': `token ${token}`
                        } 
                    }
                );
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                    console.log(`üìÑ SHA r√©cup√©r√© pour ${filename}: ${sha.substring(0, 7)}...`);
                }

                const body = {
                    message: `Mise √† jour ${filename} via Admin`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: GITHUB_CONFIG.branch
                };
                if (sha) body.sha = sha;

                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    }
                );

                if (response.ok) {
                    setStatus(section, 'saved', '‚úì √Ä jour');
                    showToast(`‚úÖ ${filename} publi√© !`, 'success');
                    publishingInProgress[section] = false;
                } else if (response.status === 409 && retryCount < 5) {
                    // Conflit - attendre un peu plus longtemps et r√©essayer
                    const delay = 1000 * (retryCount + 1); // 1s, 2s, 3s, 4s, 5s
                    console.log(`üîÑ Conflit 409 sur ${filename}, retry ${retryCount + 1}/5 dans ${delay}ms...`);
                    showToast(`üîÑ Conflit, nouvelle tentative (${retryCount + 1}/5)...`, 'warning');
                    await new Promise(r => setTimeout(r, delay));
                    publishingInProgress[section] = false;
                    return publish(section, retryCount + 1);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || `Erreur ${response.status}`);
                }
            } catch (err) {
                setStatus(section, 'modified', '‚ö†Ô∏è Erreur');
                publishingInProgress[section] = false;
                showToast('‚ùå Erreur: ' + err.message, 'error');
            }
        }

        // ===== MODAL =====
        function closeModal() {
            document.getElementById('modal-edit').classList.remove('active');
            pendingPhoto = null;
        }

        // Fermer modal avec Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // ===== TOAST =====
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.className = 'toast', 3000);
        }
    </script>

</body>
</html>
