<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilan 2020-2026 ‚Äì Vizille en Mouvement</title>
    <meta name="description" content="Bilan complet du mandat 2020-2026 : plus de 330 actions r√©alis√©es pour Vizille.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@500;600;700&family=Playfair+Display:wght@600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    
    <style>
        /* ===== PAGE BILAN CARTES ===== */
        body { padding-top: 110px; }
        
        /* Hero compact avec logo pulsant */
        .bilan-hero {
            background: linear-gradient(135deg, var(--bleu-vizille), var(--bleu-clair));
            color: white;
            padding: 2rem 1rem;
            text-align: center;
        }
        .bilan-hero .logo-pulse {
            width: 120px;
            height: auto;
            margin-bottom: 1rem;
            animation: pulse 2s ease-in-out infinite;
            filter: drop-shadow(0 4px 12px rgba(201, 162, 39, 0.5));
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 4px 12px rgba(201, 162, 39, 0.5)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 8px 24px rgba(201, 162, 39, 0.8)); }
        }
        .bilan-hero h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin: 0 0 0.5rem 0;
        }
        .bilan-hero .slogan {
            color: var(--or-clair);
            font-size: 1.1rem;
            margin: 0;
        }
        .bilan-hero .stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        .bilan-hero .stat {
            text-align: center;
        }
        .bilan-hero .stat-val {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--or-clair);
        }
        .bilan-hero .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* Onglets principaux (th√®mes) */
        .tabs-container {
            background: white;
            border-bottom: 2px solid var(--gris-doux);
            position: sticky;
            top: 110px;
            z-index: 100;
        }
        .tabs {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            overflow-x: auto;
            padding: 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        .tab {
            padding: 0.8rem 1rem;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 500;
            color: var(--gris-texte);
            font-size: 0.9rem;
        }
        .tab:hover { background: var(--blanc-casse); }
        .tab.active { font-weight: 700; border-bottom-color: var(--bleu-vizille); color: var(--bleu-vizille); }
        .tab .badge {
            background: var(--gris-doux);
            color: var(--gris-texte);
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        .tab.active .badge { background: var(--bleu-vizille); color: white; }
        
        /* Onglet Plan Climat sp√©cial */
        .tab.special { background: linear-gradient(135deg, #2c3e50, #34495e); color: white !important; }
        .tab.special:hover { background: linear-gradient(135deg, #34495e, #2c3e50); }
        .tab.special .badge { background: #9b59b6; color: white; }
        
        /* Sous-onglets (cat√©gories) */
        .subtabs-container { background: var(--blanc-casse); padding: 1rem 0; }
        .subtabs {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            padding: 0 1rem;
        }
        .subtab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 20px;
            font-size: 0.85rem;
            background: white;
            color: var(--gris-texte);
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .subtab:hover { border-color: var(--bleu-clair); }
        .subtab.active { background: var(--bleu-vizille); color: white; }
        .subtab .count { opacity: 0.7; margin-left: 0.3rem; }
        
        /* Bandeau th√®me */
        .theme-banner-container { max-width: 1400px; margin: 0 auto; padding: 1rem 1rem 0; }
        .theme-banner {
            background: linear-gradient(135deg, var(--bleu-vizille), var(--bleu-clair));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .theme-banner .icon { font-size: 2.5rem; }
        .theme-banner .text h2 { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0 0 0.3rem 0; }
        .theme-banner .text p { opacity: 0.9; font-size: 0.95rem; margin: 0; }
        .theme-banner.plan-climat { background: linear-gradient(135deg, #2c3e50, #34495e); }
        
        /* Grille de cartes */
        .cards-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        
        /* Carte action */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }
        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .card-header {
            padding: 1rem 1.2rem;
            background: linear-gradient(135deg, var(--bleu-vizille), var(--bleu-clair));
            color: white;
        }
        .card-header h3 { font-size: 1rem; line-height: 1.3; margin: 0; }
        .card-meta { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .card-meta span { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: rgba(255,255,255,0.2); }
        .card-body { padding: 1rem 1.2rem; }
        .card-body p { font-size: 0.9rem; color: var(--gris-texte); line-height: 1.5; margin: 0; }
        .card-chiffres { display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        .chiffre { text-align: center; }
        .chiffre-val { font-size: 1.3rem; font-weight: 700; color: var(--bleu-vizille); }
        .chiffre-label { font-size: 0.7rem; color: var(--gris-texte); }
        
        /* Carte objectif Plan Climat */
        .card.objectif .card-header { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .card.objectif { border-left: 4px solid #9b59b6; }
        
        /* Statut badges */
        .statut { padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .statut.realise { background: var(--vert-realise); color: white; }
        .statut.encours { background: var(--orange-encours); color: white; }
        .statut.objectif { background: #9b59b6; color: white; }
        
        /* Modal d√©tail */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--bleu-vizille), var(--bleu-clair));
            color: white;
            position: relative;
        }
        .modal-header h2 { font-size: 1.3rem; padding-right: 2rem; margin: 0; }
        .modal-close {
            position: absolute;
            top: 1rem; right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px; height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .modal-body { padding: 1.5rem; }
        .modal-section { margin-bottom: 1.5rem; }
        .modal-section h4 { color: var(--bleu-vizille); margin: 0 0 0.5rem 0; font-size: 1rem; }
        .modal-section p { margin: 0; line-height: 1.6; }
        .modal-chiffres { display: flex; gap: 1rem; flex-wrap: wrap; }
        .modal-chiffre { background: var(--gris-doux); padding: 1rem; border-radius: 8px; text-align: center; min-width: 100px; }
        .modal-chiffre .val { font-size: 1.5rem; font-weight: 700; color: var(--bleu-vizille); }
        .modal-chiffre .label { font-size: 0.8rem; }
        .chrono-item { padding: 0.5rem 0; border-left: 3px solid var(--bleu-clair); padding-left: 1rem; margin-left: 0.5rem; margin-bottom: 0.5rem; }
        .chrono-date { background: var(--bleu-vizille); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
        .source-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--gris-doux);
            border-radius: 6px;
            color: var(--bleu-vizille);
            text-decoration: none;
            font-size: 0.85rem;
            margin: 0.25rem;
        }
        .source-btn:hover { background: var(--bleu-vizille); color: white; }
        
        /* Compteur */
        .results-count { text-align: center; padding: 1rem; color: var(--gris-texte); font-size: 0.9rem; }
        
        @media (max-width: 768px) {
            body { padding-top: 80px; }
            .tabs-container { top: 80px; }
            .bilan-hero { padding: 1.5rem 1rem; }
            .bilan-hero .logo-pulse { width: 80px; }
            .bilan-hero h1 { font-size: 1.5rem; }
            .bilan-hero .stat-val { font-size: 2rem; }
            .cards-grid { grid-template-columns: 1fr; }
            .tabs { justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Aller au contenu principal</a>

    <header class="header">
        <div class="header-top"><p>Vizille en Mouvement - Municipales 2026</p></div>
        <div class="header-main">
            <a href="index.html"><img src="images/logo.png" alt="Vizille en Mouvement" class="nav-header-logo"></a>
            <button class="menu-toggle" aria-label="Menu">‚ò∞</button>
            <nav>
                <ul>
                    <li><a href="index.html">Accueil</a></li>
                    <li><a href="bilan.html" class="active">Bilan</a></li>
                    <li><a href="projet.html">Projet</a></li>
                    <li><a href="blog.html">Actualit√©s</a></li>
                    <li><a href="equipe.html">Equipe</a></li>
                    <li><a href="faq.html">Construisons ensemble</a></li>
                    <li><a href="admin.html" class="admin-link" title="Administration">‚öôÔ∏è</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <script src="js/menu-mobile.js"></script>

    <section class="bilan-hero" id="main-content">
        <img src="images/logo.png" alt="Vizille en Mouvement" class="logo-pulse">
        <h1>Bilan 2020-2026</h1>
        <p class="slogan">Ce que nous avons accompli ensemble</p>
        <div class="stats" id="hero-stats"></div>
    </section>
    
    <div class="tabs-container">
        <div class="tabs" id="tabs"></div>
    </div>
    
    <div class="theme-banner-container">
        <div class="theme-banner" id="theme-banner"></div>
    </div>
    
    <div class="subtabs-container">
        <div class="subtabs" id="subtabs"></div>
    </div>
    
    <div class="results-count" id="results-count"></div>
    
    <div class="cards-container">
        <div class="cards-grid" id="cards-grid"></div>
    </div>
    
    <!-- Modal d√©tail -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

<script>
const THEMES = [
    { id: 'Plan Climat', label: 'üåç Plan Climat', icon: 'üìã', special: true },
    { id: 'Culture', label: 'Culture', icon: 'üé≠' },
    { id: 'Environnement', label: 'Environnement', icon: 'üåø' },
    { id: 'Travaux', label: 'Travaux', icon: 'üèóÔ∏è' },
    { id: 'Patrimoine', label: 'Patrimoine', icon: 'üèõÔ∏è' },
    { id: 'Solidarit√©', label: 'Solidarit√©', icon: 'ü§ù' },
    { id: 'Sport', label: 'Sport', icon: '‚öΩ' },
    { id: 'Enfance', label: 'Enfance', icon: 'üë∂' },
    { id: 'Mobilit√©s', label: 'Mobilit√©s', icon: 'üö≤' },
    { id: 'Urbanisme', label: 'Urbanisme', icon: 'üèòÔ∏è' },
    { id: 'Tranquillit√© publique', label: 'Tranquillit√©', icon: 'üõ°Ô∏è' },
    { id: 'Finance', label: 'Finance', icon: 'üí∞' },
    { id: 'Sant√©', label: 'Sant√©', icon: 'üè•' },
    { id: 'Intercommunalit√©', label: 'Interco', icon: 'üèôÔ∏è' },
    { id: 'Administration', label: 'Admin', icon: 'üìã' },
    { id: 'Jumelages', label: 'Jumelages', icon: 'üåç' },
    { id: 'Personnel', label: 'Personnel', icon: 'üë•' }
];

const SUBCATEGORIES = {
    'Plan Climat': [
        { id: 'Axe 1 - Adaptation', label: 'Axe 1 - Adaptation', icon: 'üå≥' },
        { id: 'Axe 2 - √ânergie & Air', label: 'Axe 2 - √ânergie', icon: '‚ö°' },
        { id: 'Axe 3 - Ressources', label: 'Axe 3 - Ressources', icon: '‚ôªÔ∏è' },
        { id: 'Axe 4 - Mobilisation', label: 'Axe 4 - Mobilisation', icon: 'üë•' },
        { id: 'Axe 5 - Exemplarit√©', label: 'Axe 5 - Exemplarit√©', icon: '‚≠ê' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Culture': [
        { id: 'Festivals', label: 'Festivals & F√™tes', icon: 'üéâ' },
        { id: 'Jeunesse & Scolaires', label: 'Jeunesse', icon: 'üë¶' },
        { id: 'M√©diath√®que', label: 'M√©diath√®que', icon: 'üìö' },
        { id: 'Jeu de Paume', label: 'Jeu de Paume', icon: 'üé≠' },
        { id: 'Associations & Partenariats', label: 'Associations', icon: 'ü§ù' },
        { id: 'Art & Cr√©ation', label: 'Art', icon: 'üé®' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Environnement': [
        { id: '√ânergie & Climat', label: '√ânergie & Climat', icon: '‚ö°' },
        { id: 'D√©chets & Recyclage', label: 'D√©chets', icon: '‚ôªÔ∏è' },
        { id: 'Nature & Biodiversit√©', label: 'Nature', icon: 'üå≥' },
        { id: 'Eau', label: 'Eau', icon: 'üíß' },
        { id: 'Renouvelables', label: 'Renouvelables', icon: '‚òÄÔ∏è' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Travaux': [
        { id: 'Voirie & Espaces publics', label: 'Voirie', icon: 'üõ§Ô∏è' },
        { id: 'R√©seaux', label: 'R√©seaux', icon: 'üîß' },
        { id: '√âquipements', label: '√âquipements', icon: 'üèóÔ∏è' },
        { id: 'B√¢timents', label: 'B√¢timents', icon: 'üè¢' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Patrimoine': [
        { id: 'Monuments', label: 'Monuments', icon: '‚õ™' },
        { id: 'Circuits & Tourisme', label: 'Tourisme', icon: 'üó∫Ô∏è' },
        { id: 'Associations & Partenariats', label: 'Associations', icon: 'ü§ù' },
        { id: '√âtudes & Projets', label: '√âtudes', icon: 'üìê' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Solidarit√©': [
        { id: 'Aide internationale', label: 'Aide internationale', icon: 'üåç' },
        { id: 'Soutien √©conomique', label: 'Soutien √©co', icon: 'üíº' },
        { id: 'Actions sociales', label: 'Actions sociales', icon: 'üè†' },
        { id: '√âgalit√© & Inclusion', label: '√âgalit√©', icon: '‚öñÔ∏è' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Sport': [
        { id: '√âquipements', label: '√âquipements', icon: 'üèüÔ∏è' },
        { id: '√âv√©nements', label: '√âv√©nements', icon: 'üèÜ' },
        { id: 'Associations & Partenariats', label: 'Associations', icon: 'ü§ù' },
        { id: 'Mise √† disposition', label: 'Mise √† dispo', icon: 'üîë' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Enfance': [
        { id: 'Petite enfance', label: 'Petite enfance', icon: 'üë∂' },
        { id: '√âcoles', label: '√âcoles', icon: 'üè´' },
        { id: 'Activit√©s', label: 'Activit√©s', icon: 'üéø' },
        { id: 'Num√©rique & Jeunesse', label: 'Num√©rique', icon: 'üíª' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Mobilit√©s': [
        { id: 'Pi√©tons & V√©los', label: 'Pi√©tons & V√©los', icon: 'üö≤' },
        { id: 'Circulation', label: 'Circulation', icon: 'üöó' },
        { id: 'Stationnement', label: 'Stationnement', icon: 'üÖøÔ∏è' },
        { id: 'Arr√™t√©s & Courriers', label: 'Arr√™t√©s', icon: 'üìÑ' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Urbanisme': [
        { id: 'Grands projets', label: 'Grands projets', icon: 'üèóÔ∏è' },
        { id: 'Permis & D√©clarations', label: 'Permis', icon: 'üìù' },
        { id: '√âtudes & Diagnostics', label: '√âtudes', icon: 'üìê' },
        { id: 'Logement', label: 'Logement', icon: 'üè†' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Tranquillit√© publique': [
        { id: 'Vid√©o-protection', label: 'Vid√©o-protection', icon: 'üìπ' },
        { id: 'Pr√©vention', label: 'Pr√©vention', icon: 'üõ°Ô∏è' },
        { id: 'Police municipale', label: 'Police', icon: 'üëÆ' },
        { id: 'S√©curit√© civile', label: 'S√©curit√© civile', icon: 'üöí' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Finance': [
        { id: 'Budget', label: 'Budget', icon: 'üìä' },
        { id: 'Fiscalit√©', label: 'Fiscalit√©', icon: 'üí∂' },
        { id: 'Gestion', label: 'Gestion', icon: 'üìÅ' },
        { id: 'Distinctions', label: 'Distinctions', icon: 'üèÜ' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Sant√©': [
        { id: 'Acc√®s aux soins', label: 'Acc√®s aux soins', icon: 'üè•' },
        { id: 'Services publics', label: 'Services publics', icon: 'üèõÔ∏è' },
        { id: 'Pr√©vention', label: 'Pr√©vention', icon: 'üíä' },
        { id: 'Autres', label: 'Autres', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Intercommunalit√©': [
        { id: 'M√©tropole', label: 'M√©tropole', icon: 'üèôÔ∏è' },
        { id: 'Conventions', label: 'Conventions', icon: 'üìú' },
        { id: 'Participations', label: 'Participations', icon: 'ü§ù' },
        { id: 'V≈ìux & Actions', label: 'V≈ìux', icon: 'üì¢' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Administration': [
        { id: 'Conseil municipal', label: 'Conseil', icon: 'üèõÔ∏è' },
        { id: 'Gestion', label: 'Gestion', icon: 'üìÅ' },
        { id: 'March√©s', label: 'March√©s', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Jumelages': [
        { id: '√âchanges', label: '√âchanges', icon: 'ü§ù' },
        { id: 'Villes partenaires', label: 'Villes', icon: 'üèòÔ∏è' },
        { id: 'Gouvernance', label: 'Gouvernance', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ],
    'Personnel': [
        { id: 'Postes', label: 'Postes', icon: 'üë§' },
        { id: 'Gestion RH', label: 'Gestion RH', icon: 'üìã' },
        { id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }
    ]
};

let allData = [];
let currentTheme = 'Culture';
let currentSubcat = 'Festivals';

async function init() {
    const r = await fetch('data.json');
    allData = await r.json();
    renderHeroStats();
    renderTabs();
    renderBanner();
    renderSubtabs();
    renderCards();
}

function renderHeroStats() {
    const actionsCount = allData.filter(p => !p.suspendu && p.theme !== 'Plan Climat').length;
    const themesCount = new Set(allData.filter(p => !p.suspendu && p.theme !== 'Plan Climat').map(p => p.theme)).size;
    document.getElementById('hero-stats').innerHTML = `
        <div class="stat"><div class="stat-val">${actionsCount}</div><div class="stat-label">actions r√©alis√©es</div></div>
        <div class="stat"><div class="stat-val">${themesCount}</div><div class="stat-label">domaines d'action</div></div>
        <div class="stat"><div class="stat-val">6</div><div class="stat-label">ann√©es de mandat</div></div>
    `;
}

function renderTabs() {
    const container = document.getElementById('tabs');
    container.innerHTML = THEMES.map(t => {
        const count = allData.filter(p => p.theme === t.id && !p.suspendu).length;
        const specialClass = t.special ? 'special' : '';
        return `<div class="tab ${t.id === currentTheme ? 'active' : ''} ${specialClass}" onclick="selectTheme('${t.id}')">
            <span>${t.icon}</span>
            <span>${t.label}</span>
            <span class="badge">${count}</span>
        </div>`;
    }).join('');
}

function renderSubtabs() {
    const container = document.getElementById('subtabs');
    const defaultSubcats = [{ id: 'all', label: 'Tout voir', icon: 'üëÅÔ∏è' }];
    const subcats = SUBCATEGORIES[currentTheme] || defaultSubcats;
    
    container.innerHTML = subcats.map(s => {
        let count;
        if (s.id === 'all') {
            count = allData.filter(p => p.theme === currentTheme && !p.suspendu).length;
        } else {
            count = allData.filter(p => p.theme === currentTheme && p.sous_categorie === s.id && !p.suspendu).length;
        }
        if (count === 0 && s.id !== 'all') return '';
        return `<div class="subtab ${s.id === currentSubcat ? 'active' : ''}" onclick="selectSubcat('${s.id}')">
            ${s.icon} ${s.label} <span class="count">(${count})</span>
        </div>`;
    }).join('');
}

function renderBanner() {
    const bannerContainer = document.getElementById('theme-banner');
    const themeInfo = THEMES.find(t => t.id === currentTheme);
    const count = allData.filter(p => p.theme === currentTheme && !p.suspendu).length;
    const isPlanClimat = currentTheme === 'Plan Climat';
    const themeDescriptions = {
        'Plan Climat': 'Engagements de la Charte PCAEM 2020-2026 sign√©e avec Grenoble-Alpes M√©tropole',
        'Culture': 'Festivals, spectacles, m√©diath√®que et vie associative',
        'Environnement': 'Transition √©cologique et cadre de vie',
        'Travaux': 'R√©novations et am√©nagements',
        'Patrimoine': 'Pr√©servation et valorisation du patrimoine vizillois',
        'Solidarit√©': 'Actions sociales et entraide',
        'Sport': '√âquipements et associations sportives',
        'Enfance': 'Petite enfance, √©coles et jeunesse',
        'Mobilit√©s': 'D√©placements doux et transports',
        'Urbanisme': 'Am√©nagement du territoire',
        'Tranquillit√© publique': 'S√©curit√© et pr√©vention',
        'Finance': 'Gestion budg√©taire et finances',
        'Sant√©': 'Acc√®s aux soins et pr√©vention',
        'Intercommunalit√©': 'Coop√©ration m√©tropolitaine',
        'Administration': 'Services municipaux',
        'Jumelages': '√âchanges avec M√∂lln et Cavalese',
        'Personnel': '√âquipe municipale'
    };
    const entityLabel = isPlanClimat ? 'objectif' : 'action';
    bannerContainer.className = 'theme-banner' + (isPlanClimat ? ' plan-climat' : '');
    bannerContainer.innerHTML = `
        <div class="icon">${themeInfo.icon}</div>
        <div class="text">
            <h2>${themeInfo.id}</h2>
            <p>${themeDescriptions[currentTheme] || ''} ‚Ä¢ ${count} ${entityLabel}${count > 1 ? 's' : ''}</p>
        </div>
    `;
}

function renderCards() {
    const container = document.getElementById('cards-grid');
    let filtered = allData.filter(p => p.theme === currentTheme && !p.suspendu);
    
    if (currentSubcat !== 'all') {
        filtered = filtered.filter(p => p.sous_categorie === currentSubcat);
    }
    
    filtered.sort((a, b) => (a.importance || 5) - (b.importance || 5) || (b.annee || '').localeCompare(a.annee || ''));
    
    const isPlanClimat = currentTheme === 'Plan Climat';
    const entityLabel = isPlanClimat ? 'objectif' : 'action';
    document.getElementById('results-count').textContent = `${filtered.length} ${entityLabel}${filtered.length > 1 ? 's' : ''} affich√©${filtered.length > 1 ? 's' : ''}`;
    
    container.innerHTML = filtered.map((p, i) => {
        const isObjectif = p.statut === 'Objectif';
        const statutClass = isObjectif ? 'objectif' : (p.statut === 'R√©alis√©' ? 'realise' : 'encours');
        let chiffresHtml = '';
        if (p.chiffres && p.chiffres.length) {
            chiffresHtml = `<div class="card-chiffres">${p.chiffres.slice(0,3).map(c => 
                `<div class="chiffre"><div class="chiffre-val">${c.valeur}</div><div class="chiffre-label">${c.label}</div></div>`
            ).join('')}</div>`;
        }
        
        return `<div class="card ${isObjectif ? 'objectif' : ''}" onclick="openModal(${p.id})">
            <div class="card-header">
                <h3>${p.titre}</h3>
                <div class="card-meta">
                    ${p.statut ? `<span class="statut ${statutClass}">${p.statut}</span>` : ''}
                    ${p.annee ? `<span>üìÖ ${p.annee}</span>` : ''}
                    ${p.budget ? `<span>üí∞ ${p.budget.toLocaleString('fr-FR')} ‚Ç¨</span>` : ''}
                </div>
            </div>
            <div class="card-body">
                <p>${(p.resume || p.description || '').slice(0, 150)}${(p.resume || p.description || '').length > 150 ? '...' : ''}</p>
                ${chiffresHtml}
            </div>
        </div>`;
    }).join('');
}

function selectTheme(theme) {
    currentTheme = theme;
    const subcats = SUBCATEGORIES[currentTheme];
    if (subcats && subcats.length > 0) {
        currentSubcat = subcats[0].id;
    } else {
        currentSubcat = 'all';
    }
    renderTabs();
    renderBanner();
    renderSubtabs();
    renderCards();
}

function selectSubcat(subcat) {
    currentSubcat = subcat;
    renderSubtabs();
    renderCards();
}

function openModal(id) {
    const p = allData.find(x => x.id === id);
    if (!p) return;
    
    document.getElementById('modal-title').textContent = p.titre;
    
    let html = '';
    if (p.description) {
        html += `<div class="modal-section"><p>${p.description}</p></div>`;
    }
    if (p.chiffres && p.chiffres.length) {
        html += `<div class="modal-section"><h4>üìä Chiffres cl√©s</h4><div class="modal-chiffres">`;
        p.chiffres.forEach(c => {
            html += `<div class="modal-chiffre"><div class="val">${c.valeur}</div><div class="label">${c.label}</div></div>`;
        });
        html += `</div></div>`;
    }
    if (p.details) {
        html += `<div class="modal-section"><h4>üìã D√©tails</h4><p>${p.details}</p></div>`;
    }
    if (p.chronologie && p.chronologie.length) {
        html += `<div class="modal-section"><h4>üìÜ Chronologie</h4>`;
        p.chronologie.slice(0, 6).forEach(c => {
            html += `<div class="chrono-item"><span class="chrono-date">${c.date}</span> ${c.evenement}</div>`;
        });
        html += `</div>`;
    }
    if (p.lien_source && p.lien_source.length) {
        html += `<div class="modal-section"><h4>üîó Sources</h4>`;
        p.lien_source.forEach(s => {
            html += `<a href="${s.url}" target="_blank" class="source-btn">${s.label}</a>`;
        });
        html += `</div>`;
    }
    
    document.getElementById('modal-body').innerHTML = html;
    document.getElementById('modal-overlay').classList.add('active');
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
}

document.getElementById('modal-overlay').addEventListener('click', e => {
    if (e.target.id === 'modal-overlay') closeModal();
});

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
});

init();
</script>
</body>
</html>
